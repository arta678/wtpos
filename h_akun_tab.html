<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Daftar Akun</title>
    <link rel="icon" href="img/logo.svg">
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/noscroll.css">
    <style> 
.dropdown-menu.show {
    display:block;
    max-height:200px;
    overflow-y:auto;
    cursor:pointer;
}
.input-error {
    border: 1px solid #dc3545 !important; /* merah bootstrap */
    box-shadow: 0 0 4px rgba(220,53,69,0.4) !important;
}
#dropdown_kategori.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
#dropdown_merek.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
.dropdown-item.active-highlight {
    background-color: #007bff !important;
    color: white !important;
}
.shortcut-menu {
    gap: 10px;
    margin-top: 45px !important; /* turun dari 70 px → lebih dekat ke navbar */
}

.shortcut-item {
    width: 55px; /* dari 70px */
    text-align: center;
    text-decoration: none !important;
}

.shortcut-icon {
    width: 38px;   /* dari 50px */
    height: 38px;  /* dari 50px */
    border-radius: 10px; /* sedikit lebih kecil */
    font-size: 16px;     /* dari 20px */
    display: flex;
    justify-content: center;
    align-items: center;
    margin: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.shortcut-text {
    margin-top: 4px;
    font-size: 11px; /* dari 12px */
    color: #444;
}
.form-horizontal .form-group {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.form-horizontal label {
    width: 110px; /* lebar label (bisa diubah) */
    margin-bottom: 0;
    font-size: 13px;
    color: #333;
}

.form-horizontal .form-control,
.form-horizontal .form-select {
    flex: 1;
}
/* Agar wrapper kategori/merek ikut aturan flex dan ukurannya sama dgn input lainnya */
.form-horizontal .form-group > .position-relative {
    flex: 1;                       /* wajib */
    display: flex;                 /* biar textarea/input di dalamnya ikut full */
    align-items: center;
}

.form-horizontal .position-relative input.form-control-sm {
    width: 100%;                   /* pastikan penuh */
}
.gap-2 > * {
    margin-left: 6px;
}
.table thead th {
    background: linear-gradient(to bottom, #f5f5f5, #ededee);
    color: #7789bf;
    font-weight: 600;
    border-bottom: 2px solid #ffffff;
}
.card-body {
    padding-bottom: 0 !important;
}
.card-body nav {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
}
#pagination {
    margin: 0 !important;
    padding: 0 !important;
}
/* HANYA BARIS DATA (ISI TABEL) */
.table-tight tbody td {
    padding-top: 2px !important;
    padding-bottom: 2px !important;
    line-height: 1.15;
    vertical-align: middle;
}
.action-icon {
    cursor: pointer;
    padding: 2px;
}
tr.barisdata:hover { background:#f1f5ff; cursor:pointer }
</style>
</head>
<body id="page-top">
<div id="navbar"></div>
<div id="wrapper">
<div id="content-wrapper" class="d-flex flex-column">
<div id="content">
<div class="container-fluid">    
  <div id="shortcut"></div>
    <div class="card shadow mb-4"> 
      <div class="card-header d-flex justify-content-between align-items-center py-2 flex-wrap">
          <h6 class="m-0 font-weight-bold text-primary">Daftar Akun</h6>
          <span id="offlineBadge" class="badge badge-warning d-none">Offline</span>
          <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
                <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" style="width: 80px; text-align: left;" type="button" id="filterStatusBtn" data-toggle="dropdown">Semua</button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="#" onclick="setFilterStatus('all')">Semua</a>
                        <a class="dropdown-item" href="#" onclick="setFilterStatus('active')">Aktif</a>
                        <a class="dropdown-item" href="#" onclick="setFilterStatus('nonactive')">Nonaktif</a>
                    </div>
                </div>
              <input type="text" id="cari_akun" class="form-control form-control-sm" placeholder="Cari Akun..." style="max-width: 200px;">
              <!-- <a href="h_pembelian_tab.html" class="btn btn-primary btn-sm">Tambah Akun</a> -->
          </div>
      </div>
      <div class="card-body table-responsive d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <table class="table table-hover table-sm table-bordered table-tight">
        <thead>
          <tr>
            <th width="100px">Kode</th>
            <th>Nama</th>
            <th width="250px">Klasifikasi</th>
            <th width="150px">Saldo Awal</th>
            <th width="50px">Aktif</th>
            <th width="80" class="text-center">Aksi</th>
          </tr>
        </thead>
        <tbody id="tb_akun"></tbody>
      </table>
    <nav>
      <ul class="pagination justify-content-center" id="pagination">
        <li class="page-item">
          <a class="page-link" href="#" onclick="prevPage()">&laquo;</a>
      </li>

      <li class="page-item disabled">
          <a class="page-link" href="#">
            Halaman <span id="page-number">1</span>
        </a>
    </li>
    <li class="page-item">
      <a class="page-link" href="#" onclick="nextPage()">&raquo;</a>
  </li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>
<script src="js/navbar_on_off.js"></script>
<script>
function initNavbarQuickSearch() {
  const nav = document.getElementById("navbar");
  if (!nav) return;
  const input = nav.querySelector("#quickSearchInput");
  if (!input || input.dataset.bound) return;
  input.dataset.bound = "1";
  input.addEventListener("keydown", e => {
    if (e.key !== "Enter") return;
    e.preventDefault();
    const q = input.value.trim();
    if (!q) return;
    location.href =
      "h_harga_produk.html?q=" + encodeURIComponent(q);
  });
}
async function loadNavbar() {
  const navEl = document.getElementById("navbar");
  if (localStorage.getItem("navbar")) {
    navEl.innerHTML = localStorage.getItem("navbar");
    navEl.classList.add("loaded");
  }
  const res = await fetch("navbar.html");
  const html = await res.text();
  localStorage.setItem("navbar", html);
  navEl.innerHTML = html;
  navEl.classList.add("loaded");
  if (typeof applyShortcutVisibility === "function") {
    applyShortcutVisibility();
  }
  initNavbarQuickSearch();
}
async function loadShortcut() {
  if (!isShortcutEnabled()) {
    const el = document.getElementById("shortcut");
    if (el) el.style.display = "none";
    return;
  }

  const el = document.getElementById("shortcut");

  if (localStorage.getItem("shortcut_html")) {
    el.innerHTML = localStorage.getItem("shortcut_html");
    applyShortcutIcons(); // ⬅️ WAJIB
  }

  const res = await fetch("shortcut.html");
  const html = await res.text();

  localStorage.setItem("shortcut_html", html);
  el.innerHTML = html;

  applyShortcutIcons(); // ⬅️ WAJIB
}
loadNavbar();
loadShortcut();
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/db_supabase.js"></script>
<script>
/* =================== STATE =================== */
const perPage = 10;
let page = 1;
let totalPages = 1;
let allAkun = [];
let filterAktif = "all";

function clearCacheAkun(){
  localStorage.removeItem("cache_akun_all");
}

/* ================= UI ================= */
function setFilterStatus(val){
  filterAktif = val;
  page = 1;

  document.getElementById("filterStatusBtn").innerText =
    val === "active" ? "Aktif" :
    val === "nonactive" ? "Nonaktif" :
    "Semua";

  applyFilterAkun();
}

function fmt(n){
  return (n || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
}

/* ================= LOAD DATA (SEKALI) ================= */
async function loadAkun(){

  // 1️⃣ TAMPILKAN CACHE DULU (INSTANT)
  const cache = localStorage.getItem("cache_akun_all");
  if(cache){
    allAkun = JSON.parse(cache);
    applyFilterAkun();
    if(!navigator.onLine) return;
  }

  // 2️⃣ FETCH SUPABASE
  const { data, error } = await db
    .from("tb_akun")
    .select(`
      id_akun,
      kode_akun,
      nama_akun,
      saldo_awal,
      aktif,
      tb_klasifikasi_akun(nama_klasifikasi)
    `)
    .order("kode_akun");

  if(error){
    console.error(error);
    return;
  }

  allAkun = data;
  localStorage.setItem("cache_akun_all", JSON.stringify(data));

  applyFilterAkun();
}


/* ================= FILTER + PAGINATION ================= */
function applyFilterAkun(){

  let result = allAkun;

  // ===== FILTER STATUS =====
  if(filterAktif === "active"){
    result = result.filter(a => a.aktif === true);
  } else if(filterAktif === "nonactive"){
    result = result.filter(a => a.aktif === false);
  }

  // ===== SEARCH (ENTER SAJA) =====
  const q = document.getElementById("cari_akun").value.trim().toLowerCase();
  if(q){
    result = result.filter(a =>
      (a.kode_akun || "").toLowerCase().includes(q) ||
      (a.nama_akun || "").toLowerCase().includes(q)
    );
  }

  // ===== PAGINATION =====
  totalPages = Math.ceil(result.length / perPage);
  if(page < 1) page = 1;
  if(page > totalPages) page = totalPages || 1;

  const start = (page - 1) * perPage;
  const end   = start + perPage;

  renderAkun(result.slice(start, end));
  updatePaginationAkun();
}

/* ================= RENDER ================= */
function renderAkun(list){
  const tb = document.getElementById("tb_akun");

  if(!list.length){
    tb.innerHTML = `
      <tr>
        <td colspan="7" class="text-center text-muted py-3">
          Tidak ada data
        </td>
      </tr>`;
    return;
  }
  tb.innerHTML = list.map(r => `
    <tr class="barisdata">
      <td>${r.kode_akun}</td>
      <td>${r.nama_akun}</td>
      <td>${r.tb_klasifikasi_akun?.nama_klasifikasi || "-"}</td>
      <td class="text-right">${fmt(r.saldo_awal)}</td>
      <td class="text-center">
        ${r.aktif
          ? '<i class="fas fa-check text-primary"></i>'
          : '<i class="fas fa-times text-danger"></i>'}
      </td>
      <td class="text-center">
        <i class="fas fa-edit text-primary mr-2 action-icon" onclick="goEdit('${r.id_akun}')"></i>
      </td>
    </tr>
  `).join("");
}

/* ================= PAGINATION ================= */
function nextPage(){
  if(page >= totalPages) return;
  page++;
  applyFilterAkun();
}

function prevPage(){
  if(page <= 1) return;
  page--;
  applyFilterAkun();
}

function updatePaginationAkun(){
  document.getElementById("page-number").innerText = page;

  document.querySelector("#pagination li:first-child")
    .classList.toggle("disabled", page <= 1);

  document.querySelector("#pagination li:last-child")
    .classList.toggle("disabled", page >= totalPages);
}

function goEdit(id) {
location.href = "h_akun_edit.html?id="+id;
}


/* ================= EVENTS ================= */
document.getElementById("cari_akun")
  .addEventListener("keydown", e => {
    if(e.key === "Enter"){
      page = 1;
      applyFilterAkun();
    }
  });

/* ================= INIT ================= */
loadAkun();
</script>

</body>
</html>
