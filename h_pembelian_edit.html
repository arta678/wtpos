<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Edit Pembelian</title>
    <link rel="icon" href="img/logo.svg">
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/noscroll.css">
    <style>
.dropdown-menu.show {
    display:block;
    max-height:200px;
    overflow-y:auto;
    cursor:pointer;
}
.input-error {
    border: 1px solid #dc3545 !important; /* merah bootstrap */
    box-shadow: 0 0 4px rgba(220,53,69,0.4) !important;
}
#dropdown_kategori.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
#dropdown_merek.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
.dropdown-item.active-highlight {
    background-color: #007bff !important;
    color: white !important;
}

table {
  overflow: visible !important;
}

table tbody,
table tr,
table td {
  overflow: visible !important;
}

.dd-produk {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 9999 !important;
}
/* === FIX dropdown produk terpotong === */
.table-responsive {
  overflow: visible !important;
}

.table-responsive table,
.table-responsive tbody,
.table-responsive tr,
.table-responsive td {
  overflow: visible !important;
}

.dd-produk {
    min-width: 350px !important;  /* atur sesuai kebutuhan */
    white-space: normal !important; /* biar teks turun ke bawah, bukan terpotong */
}
.dropdown-item.active-highlight {
    background-color: #007bff !important;
    color: white !important;
}

/* Semua input & select di dalam tabel pembelian */
#tbl input.form-control-sm,
#tbl select.form-control-sm {
    border-radius: 7px !important;   /* ubah sesuai selera: 4px, 8px, 12px */
}
.dropdown-item.active-highlight {
    background: #007bff !important;
    color: #fff !important;
}
.dropdown-menu.show {
    display:block;
    max-height:200px;
    overflow-y:auto;
    cursor:pointer;
}
.input-error {
    border: 1px solid #dc3545 !important; /* merah bootstrap */
    box-shadow: 0 0 4px rgba(220,53,69,0.4) !important;
}
#dropdown_kategori.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
#dropdown_merek.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
.dropdown-item.active-highlight {
    background-color: #4d5061  !important;
    color: white !important;
}
.shortcut-menu {
    gap: 10px;
    margin-top: 45px !important; /* turun dari 70 px ‚Üí lebih dekat ke navbar */
}

.shortcut-item {
    width: 55px; /* dari 70px */
    text-align: center;
    text-decoration: none !important;
}

.shortcut-icon {
    width: 38px;   /* dari 50px */
    height: 38px;  /* dari 50px */
    border-radius: 10px; /* sedikit lebih kecil */
    font-size: 16px;     /* dari 20px */
    display: flex;
    justify-content: center;
    align-items: center;
    margin: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.shortcut-text {
    margin-top: 4px;
    font-size: 11px; /* dari 12px */
    color: #444;
}
.form-horizontal .form-group {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.form-horizontal label {
    width: 110px; /* lebar label (bisa diubah) */
    margin-bottom: 0;
    font-size: 13px;
    color: #333;
}

.form-horizontal .form-control,
.form-horizontal .form-select {
    flex: 1;
}
/* Agar wrapper kategori/merek ikut aturan flex dan ukurannya sama dgn input lainnya */
.form-horizontal .form-group > .position-relative {
    flex: 1;                       /* wajib */
    display: flex;                 /* biar textarea/input di dalamnya ikut full */
    align-items: center;
}

.form-horizontal .position-relative input.form-control-sm {
    width: 100%;                   /* pastikan penuh */
}
.gap-2 > * {
    margin-left: 6px;
}
.card-body {
    padding-bottom: 10px !important;
}

#pagination {
    margin: 0 !important;
    padding: 0 !important;
}
.inp-nama {
    white-space: normal !important;   /* izinkan teks panjang */
    overflow: visible !important;
    text-overflow: unset !important;
}
#col-tempo,
#col-jatuh-tempo {
    display: none;
}

</style>
</head>
<body id="page-top">
<div id="navbar"></div>
    <div id="wrapper">
<!-- CONTENT -->
  <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
<div class="container-fluid">    
  <div id="shortcut"></div>
  <div class="card shadow mb-4"> 
    <div class="card-header d-flex justify-content-between align-items-center py-2">
      <!-- JUDUL -->
      <h6 class="m-0 font-weight-bold text-primary">Edit Pembelian</h6>
        <div class="d-flex gap-2 align-items-center">
            <button type="submit" id="btnSave" form="form" class="btn btn-primary btn-sm">Simpan</button>
            <a href="h_pembelian_tab.html" class="btn btn-secondary btn-sm" id="btnKembali">Kembali</a>
        </div>
    </div>
    <div class="card-body">
          <form id="form">
            <div class="form-row">
              <div>
                <!-- <small>Kode</small> -->
                <input type="hidden" id="kode">
              </div>
              <div class="col-md-2 mb-2">
                <small>Tanggal</small>
                <input type="date" id="tanggal" class="form-control form-control-sm">
              </div>
                            <div class="col-md-3 mb-2">
                <small>Supplier</small>
                <input id="cari_mitra" class="form-control form-control-sm" placeholder="CASH">
                <div id="dd_mitra" class="dropdown-menu w-100"></div>
              </div>
              <div class="col-md-2 mb-2">
                <small>Termin</small>
                <select id="termin" class="form-control form-control-sm">
                    <option value="cash">CASH</option>
                    <option value="credit">CREDIT</option>
                </select>
              </div>

            <div class="col-md-2 mb-2" id="col-tempo">
              <small id="lbl-tempo">Tempo (hari)</small>
              <input id="tempo" type="number" min="0" class="form-control form-control-sm" value="0">
            </div>

            <div class="col-md-2 mb-2" id="col-jatuh-tempo">
              <small>Tanggal Jatuh Tempo</small>
              <input type="date" id="jatuh_tempo" class="form-control form-control-sm" readonly>
            </div>

            <div class="col-md-2 mb-2" id="wrap_pembayaran">
              <small>Pembayaran</small>
              <select id="pembayaran" class="form-control form-control-sm">
                <option value="">Kas Utama</option>
              </select>
            </div>


              <input id="keterangan" class="form-control form-control-sm" type="hidden" >
            </div>
            <div class="table-responsive mt-2">
              <table class="table table-sm  table-borderless" id="tbl">
                <thead class="table-secondary">
                    <tr>
                        <th width="30px">No.</th>
                        <th>Item</th>
                        <th width="70px">Qty</th>
                        <th width="100px">Satuan</th>
                        <th width="100px">Harga</th>
                        <th width="100px">Diskon<t/h>
                        <!-- <th>Diskon</th> -->
                        <th width="110px">Pajak</th>
                        <th width="220px">Subtotal</th>
                        <th width="30px">Aksi</th>
                    </tr>
                </thead>
                <tbody class="table-borderless"></tbody>
              </table>
            </div>
            <div class="row mt-2">
              <div class="col-md-6"></div>
              <div class="col-md-6">
                <table class="table table-borderless table-sm">
                  <tr><td class="text-right small">Sub Total</td><td class="text-right" id="subTxt">0</td></tr>
                  <tr><td class="text-right small">Diskon Total (Rp)</td><td><input id="diskon_total" class="form-control form-control-sm text-right" value="0"></td></tr>
                  <tr><td class="text-right small">Biaya Lain (Rp)</td><td><input id="biaya_lain" class="form-control form-control-sm text-right" value="0"></td></tr>
                  <tr><td class="text-right font-weight-bold">Grand Total</td><td class="text-right font-weight-bold" id="grandTxt">0</td></tr>
                </table>
              </div>
            </div>
          </form>
      </div>
    </div>
    <div class="modal fade" id="modalTambahMerek" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title">Tambah Merek Baru</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <div class="modal-body">
        <label>Kode</label>
        <input type="text" id="kode_merek_baru" class="form-control mb-3" placeholder="AUTO">

        <label>Nama Merek</label>
        <input type="text" id="nama_merek_baru" class="form-control">
      </div>

      <div class="modal-footer">
        <button id="btnSimpanMerekBaru" class="btn btn-primary" onclick="simpanMerekBaru()">Simpan</button>
        <button class="btn btn-secondary" data-dismiss="modal">Batal</button>
      </div>

    </div>
  </div>


</div>
  <div class="modal fade" id="modalTambahKategori" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title">Tambah Kategori Baru</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <div class="modal-body">
        <label>Kode</label>
        <input type="text" id="kode_kategori_baru" class="form-control mb-3" placeholder="AUTO">

        <label>Nama Kategori</label>
        <input type="text" id="nama_kategori_baru" class="form-control">
      </div>

      <div class="modal-footer">
        <button id="btnSimpanKategoriBaru" class="btn btn-primary" onclick="simpanKategoriBaru()">Simpan</button>
        <button class="btn btn-secondary" data-dismiss="modal">Batal</button>
      </div>

    </div>
  </div>
</div>

</div>
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>
<script src="js/navbar_on_off.js"></script>
<script>
function initNavbarQuickSearch() {
  const nav = document.getElementById("navbar");
  if (!nav) return;
  const input = nav.querySelector("#quickSearchInput");
  if (!input || input.dataset.bound) return;
  input.dataset.bound = "1";
  input.addEventListener("keydown", e => {
    if (e.key !== "Enter") return;
    e.preventDefault();
    const q = input.value.trim();
    if (!q) return;
    location.href =
      "h_harga_produk.html?q=" + encodeURIComponent(q);
  });
}
async function loadNavbar() {
  const navEl = document.getElementById("navbar");
  if (localStorage.getItem("navbar")) {
    navEl.innerHTML = localStorage.getItem("navbar");
    navEl.classList.add("loaded");
  }
  const res = await fetch("navbar.html");
  const html = await res.text();
  localStorage.setItem("navbar", html);
  navEl.innerHTML = html;
  navEl.classList.add("loaded");
  if (typeof applyShortcutVisibility === "function") {
    applyShortcutVisibility();
  }
  initNavbarQuickSearch();
}
async function loadShortcut() {
  if (!isShortcutEnabled()) {
    const el = document.getElementById("shortcut");
    if (el) el.style.display = "none";
    return;
  }

  const el = document.getElementById("shortcut");

  if (localStorage.getItem("shortcut_html")) {
    el.innerHTML = localStorage.getItem("shortcut_html");
    applyShortcutIcons(); // ‚¨ÖÔ∏è WAJIB
  }

  const res = await fetch("shortcut.html");
  const html = await res.text();

  localStorage.setItem("shortcut_html", html);
  el.innerHTML = html;

  applyShortcutIcons(); // ‚¨ÖÔ∏è WAJIB
}
loadNavbar();
loadShortcut();
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/db_supabase.js"></script>
<script>


const params = new URLSearchParams(window.location.search);
const ID_PEMBELIAN = params.get("id");

if (!ID_PEMBELIAN) {
  alert("ID pembelian tidak ditemukan");
  location.href = "h_pembelian_tab.html";
}

async function loadPembelianHeader() {
  const { data, error } = await db
    .from("tb_pembelian")
    .select(`
      *,
      tb_mitra (
        id_mitra,
        nama_mitra,
        akun_hutang
      )
    `)
    .eq("id_pembelian", ID_PEMBELIAN)
    .single();

  if (error || !data) {
    alert("Data pembelian tidak ditemukan");
    return;
  }

  kode.value = data.kode_pembelian;
  tanggal.value = data.tanggal;
  termin.value = data.termin;
  originalTempoPembelian = data.tempo || 0;
  tempo.value = originalTempoPembelian;
  jatuh_tempo.value = data.tanggal_jatuh_tempo || "";

  diskon_total.value = fmt(data.total_diskon);
  biaya_lain.value = fmt(data.total_biaya_lain);

  cari_mitra.value = data.tb_mitra.nama_mitra;
  cari_mitra.dataset.id = data.tb_mitra.id_mitra;
  cari_mitra.dataset.akun_hutang = data.tb_mitra.akun_hutang;

  updateTerminUI();
}

async function restorePembayaranCashFromJurnal() {
  // hanya untuk CASH
  if (termin.value !== "cash") return;

  const { data: jurnalOld, error } = await db
    .from("tb_jurnal")
    .select(`
      tb_jurnal_detail (
        kode_akun,
        debit,
        kredit
      )
    `)
    .eq("sumber", "pembelian")
    .eq("id_source", ID_PEMBELIAN)
    .single();

  if (error || !jurnalOld || !jurnalOld.tb_jurnal_detail) return;

  // cari baris kredit (kas/bank)
  const kreditRow = jurnalOld.tb_jurnal_detail.find(j => j.kredit > 0);
  if (!kreditRow) return;

  // cari id_kasbank yang sesuai kode_akun
  const idKas = Object.keys(kasbankMap)
    .find(id => kasbankMap[id] === kreditRow.kode_akun);

  if (idKas) {
    pembayaran.value = idKas;
  }
}


async function loadPembelianDetail() {
  const { data, error } = await db
    .from("tb_pembelian_detail")
    .select("*")
    .eq("id_pembelian", ID_PEMBELIAN)
    .order("id_detail");

  if (error) {
    alert("Gagal load detail pembelian");
    return;
  }

  tblBody.innerHTML = "";

  data.forEach(d => {
    const tr = createRow();

    tr.querySelector(".inp-nama").value = d.nama_item;
    tr.querySelector(".inp-nama").dataset.id = d.id_produk;

    tr.querySelector(".inp-qty").value = d.qty;

    const sel = tr.querySelector(".inp-satuan");
    sel.innerHTML = `<option value="${d.satuan}">${d.satuan}</option>`;
    sel.value = d.satuan;

    tr.querySelector(".inp-harga").value = fmt(d.harga);
    tr.querySelector(".inp-diskon").value = fmt(d.diskon_item);
    tr.querySelector(".subtotal-cell").innerText = fmt(d.subtotal);

    tblBody.appendChild(tr);
  });

  refreshRowNumbers();
  refreshTotals();
}

async function rollbackPembelianLama() {
  // 1. hapus mutasi stok lama
  await db
    .from("tb_stock_mutasi")
    .delete()
    .eq("sumber", "pembelian")
    .eq("ref_id", ID_PEMBELIAN);

  // 2. hapus jurnal lama
  const { data: j } = await db
    .from("tb_jurnal")
    .select("id_jurnal")
    .eq("sumber", "pembelian")
    .eq("id_source", ID_PEMBELIAN)
    .single();

  if (j) {
    await db.from("tb_jurnal_detail").delete().eq("id_jurnal", j.id_jurnal);
    await db.from("tb_jurnal").delete().eq("id_jurnal", j.id_jurnal);
  }

  // 3. hapus hutang lama
  await db.from("tb_hutang").delete().eq("id_pembelian", ID_PEMBELIAN);

  // 4. hapus detail lama
  await db.from("tb_pembelian_detail").delete().eq("id_pembelian", ID_PEMBELIAN);
}



// ===================== HELPERS =====================
function fmt(n){ return (n==null||n===0) ? '0' : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }
function toNum(s){ return parseFloat((s||'').toString().replace(/\./g,'')) || 0; }

function formatRupiahInput(el) {
    el.addEventListener("input", () => {
        let val = el.value.replace(/\D/g, ""); // hanya angka
        if (val === "") {
            el.value = "";
            return;
        }
        el.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    });
}

function intOnlyInput(el){
  if(!el) return;
  el.addEventListener('input', ()=> {
    el.value = el.value.replace(/\D/g,'');
  });
}

function soundError() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = "sawtooth";
    osc.frequency.value = 200;

    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);

    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start();
    osc.stop(ctx.currentTime + 0.25);
}

function parseDiskon(raw, qty, harga){
  if(!raw) return 0;

  raw = raw.toString().trim();
  const parts = raw.split('+').map(p => p.trim()).filter(Boolean);

  let hargaAkhir = harga;

  for(const p of parts){
    if(p.endsWith('%')){
      // DISKON PERSEN BERTINGKAT
      const pct = parseFloat(p.replace('%','')) || 0;
      const pot = Math.floor(hargaAkhir * pct / 100);
      hargaAkhir -= pot;
    } else {
      // DISKON NOMINAL (PER UNIT)
      const val = parseInt(p.replace(/\./g,'').replace(/,/g,'')) || 0;
      hargaAkhir -= val;
    }

    // safety: jangan minus
    if(hargaAkhir < 0) hargaAkhir = 0;
  }

  // total diskon = (harga awal - harga akhir) √ó qty
  return (harga - hargaAkhir) * qty;
}


function cleanDiskonInput(el){
    el.addEventListener("input", () => {
        el.value = el.value
            .replace(/[^0-9+.%]/g, "")  // hanya angka, +, ., %
            .replace(/(\++)+/g, "+")    // hilangkan ++ menjadi +
            .replace(/(\.)+/g, ".");    // hilangkan .. menjadi .
    });
}

// ===================== ELEMENTS =====================
const kode = document.getElementById('kode');
const tanggal = document.getElementById('tanggal');
const cari_mitra = document.getElementById('cari_mitra');
const dd_mitra = document.getElementById('dd_mitra');
const termin = document.getElementById('termin');
const tempo = document.getElementById('tempo');
const jatuh_tempo = document.getElementById("jatuh_tempo");
const keterangan = document.getElementById('keterangan');
const tblBody = document.querySelector('#tbl tbody');
const subTxt = document.getElementById('subTxt');
const diskon_total = document.getElementById('diskon_total');
const biaya_lain = document.getElementById('biaya_lain');
const grandTxt = document.getElementById('grandTxt');
const btnSave = document.getElementById('btnSave');
let isSettingDefaultSupplier = false;
const wrapPembayaran = document.getElementById("wrap_pembayaran");
const pembayaran = document.getElementById("pembayaran");
const DEFAULT_KASBANK_KODE = "KS01"; // Kas Utama
let AKUN_PERSEDIAAN = null;
let kasbankMap = {}; // id_kasbank -> kode_akun
let kasbankLoaded = false;
let originalTempoPembelian = 0;


// kode untuk menampilkan detail pembelian
const mode = new URLSearchParams(location.search).get("mode");
if (mode === "view") {
  btnSave.style.display = "none";
  btnKembali.style.display = "none";
  document.querySelectorAll("number,input,select,textarea")
    .forEach(el => el.setAttribute("disabled","disabled"));
}


async function preloadSettingAkun() {
  const { data, error } = await db
    .from("tb_setting_akun")
    .select("kode_akun")
    .eq("key", "inventory")
    .single();

  if (error || !data) {
    console.warn("Setting akun inventory belum ada");
    return;
  }

  AKUN_PERSEDIAAN = data.kode_akun;
}


termin.value = "cash";
tempo.value = 0;
tempo.setAttribute("disabled", "disabled");
jatuh_tempo.value = "";

intOnlyInput(diskon_total);
intOnlyInput(biaya_lain);
tanggal.value = new Date().toISOString().slice(0,10);

const colTempo = document.getElementById("col-tempo");
const colJatuhTempo = document.getElementById("col-jatuh-tempo");

function updateTerminUI() {
  if (termin.value === "cash") {

    // üîπ CASH ‚Üí sembunyikan tempo & jatuh tempo
    colTempo.style.display = "none";
    colJatuhTempo.style.display = "none";
    jatuh_tempo.value = "";

    // üîπ tampilkan pembayaran
    wrapPembayaran.style.display = "block";

    loadKasBank();

  } else {

    // üîπ CREDIT ‚Üí tampilkan tempo & jatuh tempo
    colTempo.style.display = "block";
    colJatuhTempo.style.display = "block";
    tempo.removeAttribute("disabled");

    // üîπ sembunyikan pembayaran
    wrapPembayaran.style.display = "none";
    pembayaran.value = "";
  }

  updateJatuhTempo();
}

async function loadKasBank() {
      if (kasbankLoaded) return;
      kasbankLoaded = true;
      const { data, error } = await db
        .from("tb_kasbank")
        .select("id_kasbank, kode, nama_rekening, tipe, kode_akun")
        .eq("aktif", true)
        .order("tipe")
        .order("nama_rekening");

      if (error) {
        console.error("Gagal load kasbank", error);
        return;
      }

      pembayaran.innerHTML = `<option value="">Pilih</option>`;
      kasbankMap = {};

      data.forEach(d => {
        // üî• CACHE DI SINI
        kasbankMap[d.id_kasbank] = d.kode_akun;

        pembayaran.innerHTML += `
          <option value="${d.id_kasbank}">
            ${d.nama_rekening}
          </option>
        `;
      });

      // auto pilih Kas Utama
      const def = data.find(d => d.kode === DEFAULT_KASBANK_KODE);
      if (def) pembayaran.value = def.id_kasbank;
}


function updateJatuhTempo() {
    const tgl = tanggal.value;
    const isCredit = termin.value === "credit";
    const tempoHari = parseInt(tempo.value) || 0;

    if (!tgl || !isCredit || tempoHari <= 0) {
        jatuh_tempo.value = "";
        return;
    }

    const d = new Date(tgl);
    d.setDate(d.getDate() + tempoHari);

    jatuh_tempo.value = d.toISOString().slice(0, 10);
}
tanggal.addEventListener("change", updateJatuhTempo);
tempo.addEventListener("input", updateJatuhTempo);
tempo.addEventListener("keydown", function(e){
    if (e.key === "Enter") {
        e.preventDefault();

        // Fokus ke input produk baris pertama
        const firstProduk = tblBody.querySelector("tr.line-row:first-child .inp-nama");
        if (firstProduk) {
            firstProduk.focus();
            firstProduk.select();
        }
    }
});


let mitraItems = [];
let mitraIndex = -1;
cari_mitra.addEventListener("keydown", function(e){
    // Jika dropdown tidak tampil ‚Üí abaikan navigasi
    if (!dd_mitra.classList.contains("show")) return;

    if (e.key === "ArrowDown") {
        e.preventDefault();
        if (mitraItems.length === 0) return;
        mitraIndex = (mitraIndex + 1) % mitraItems.length;
    }

    if (e.key === "ArrowUp") {
        e.preventDefault();
        if (mitraItems.length === 0) return;
        mitraIndex = (mitraIndex - 1 + mitraItems.length) % mitraItems.length;
    }

    // ENTER pilih supplier
    if (e.key === "Enter") {
        e.preventDefault();
        if (mitraIndex >= 0 && mitraItems[mitraIndex]) {
            mitraItems[mitraIndex].click();
        }
    }

    updateMitraHighlight();
});
function updateMitraHighlight() {
    mitraItems.forEach(el => el.classList.remove("active-highlight"));
    if (mitraIndex >= 0 && mitraItems[mitraIndex]) {
        mitraItems[mitraIndex].classList.add("active-highlight");
        mitraItems[mitraIndex].scrollIntoView({ block: "nearest" });
    }
}

// ===================== MITRA SEARCH =====================
let timerM = null;

cari_mitra.addEventListener('input', function (e) {

  // üîí Abaikan input dari sistem (default / set otomatis)
  if (isSettingDefaultSupplier) return;

  // üîí Abaikan input non-user (safety tambahan)
  if (!e.isTrusted) return;

  // ‚ùó reset ID HANYA kalau user benar-benar mengetik
  this.dataset.id = "";

  if (this.value.trim() === "") {
    termin.value = "cash";
    tempo.value = 0;
    tempo.setAttribute("disabled","disabled");
    jatuh_tempo.value = "";
  }

  clearTimeout(timerM);

  const kw = this.value.trim();
  if (kw.length < 3) {
    dd_mitra.classList.remove('show');
    dd_mitra.innerHTML = "";
    return;
  }

  dd_mitra.classList.add('show');

  timerM = setTimeout(async () => {
    const { data } = await db
      .from('tb_mitra')
      .select('id_mitra,nama_mitra,termin_pembelian,tempo_pembelian,akun_hutang')
      .ilike('nama_mitra', `%${kw}%`)
      .limit(15);

    if (!data || !data.length) {
      dd_mitra.innerHTML = `<div class="dropdown-item text-muted">Tidak ada</div>`;
      return;
    }

    dd_mitra.innerHTML = data.map(m => `
      <div class="dropdown-item"
        data-id="${m.id_mitra}"
        data-nama="${m.nama_mitra}"
        data-termin="${m.termin_pembelian || 'cash'}"
        data-tempo="${m.tempo_pembelian || 0}"
        data-akun="${m.akun_hutang || ''}">
        ${m.nama_mitra}
      </div>
    `).join("");

    dd_mitra.classList.add("show");
    mitraItems = Array.from(dd_mitra.querySelectorAll(".dropdown-item"));
    mitraIndex = -1;

  }, 200);
});

// --- ketika pilih supplier dari dropdown ---
dd_mitra.addEventListener('click', e => {
  const it = e.target.closest('.dropdown-item');
  if(!it) return;

  // simpan informasi supplier di input cari_mitra
  cari_mitra.value = it.dataset.nama;
  cari_mitra.dataset.id = it.dataset.id;
  // simpan tempo asli supplier (string) agar bisa dipakai kembali
  cari_mitra.dataset.tempo = it.dataset.tempo || "0";
  cari_mitra.dataset.termin = it.dataset.termin || "cash";
  cari_mitra.dataset.akun_hutang = it.dataset.akun || "";

  // set termin & tempo berdasarkan data supplier
  termin.value = cari_mitra.dataset.termin;
  termin.dispatchEvent(new Event("change"));

  if (termin.value === 'cash') {
    // kalau cash -> tempo disabled dan kosong (atau 0 sesuai preferensi)
    tempo.value = 0;
    tempo.setAttribute('disabled','disabled');

    // fokus ke input produk langsung
    setTimeout(()=>{
      const firstProduk = tblBody.querySelector('tr.line-row:first-child .inp-nama');
      if(firstProduk){ firstProduk.focus(); firstProduk.select(); }
    }, 10);
  } else {
    // credit -> aktifkan tempo dan isi dengan tempo supplier yang sudah disimpan
    tempo.removeAttribute('disabled');
    // pastikan parseInt aman dan fallback jika kosong
    const supplierTempo = parseInt(cari_mitra.dataset.tempo || "0") || 0;
    tempo.value = supplierTempo;

    // fokus ke tempo supaya user bisa ubah kalau perlu
    setTimeout(()=> {
      tempo.focus();
      tempo.select && tempo.select();
    }, 10);
  }

  dd_mitra.classList.remove('show');
  updateJatuhTempo();
});

// ===================== DYNAMIC ROWS =====================
const TAX_RATES = { NO:0, PPN:0.10 };

function createRow(){
  const tr = document.createElement('tr');
  tr.className = 'line-row';

  tr.innerHTML = `
    <td class="line-no text-center"></td>

    <td>
      <div style="position:relative">
        <input type="text" class="form-control form-control-sm inp-nama" placeholder="Cari Produk">
        <div class="dropdown-menu dd-produk w-100"></div>
      </div>
    </td>

    <td><input class="form-control form-control-sm inp-qty text-right" value="1"></td>

    <td>
      <select class="form-control form-control-sm inp-satuan">
        <option value="">Pilih Satuan</option>
      </select>
    </td>

    <td><input class="form-control form-control-sm inp-harga text-right" value="0"></td>

    <td><input class="form-control form-control-sm inp-diskon text-right"></td>

    <td>
      <select class="form-control form-control-sm inp-pajak">
        <option value="NO">No Pajak</option>
        <option value="PPN">PPN</option>
      </select>
    </td>

    <td class="subtotal-cell text-right">0</td>

    <td class="text-center">
      <button type="button" class="btn btn-sm btn-light btn-delete"><i class="fas fa-trash"></i></button>
    </td>
  `;

  attachRowHandlers(tr);
  return tr;
}

function moveRowFocus(currentInput, direction) {
    const row = currentInput.closest("tr.line-row");
    if (!row) return;

    const allRows = Array.from(tblBody.querySelectorAll("tr.line-row"));
    const index = allRows.indexOf(row);
    const newIndex = index + direction;

    if (newIndex < 0 || newIndex >= allRows.length) return;

    // cari kolom yang sama di baris berikutnya
    const className = "." + currentInput.classList[2];
    const nextInput = allRows[newIndex].querySelector(className);

    if (nextInput) {
        nextInput.focus();
        nextInput.select?.();
    }
}

// =============== ATTACH ROW HANDLERS ==================
function attachRowHandlers(tr){
  refreshRowNumbers();
  const inpNama  = tr.querySelector('.inp-nama');
  const inpQty   = tr.querySelector('.inp-qty');
  const inpHarga = tr.querySelector('.inp-harga');
  const inpDiskon= tr.querySelector('.inp-diskon');
  const selSatuan= tr.querySelector('.inp-satuan');
  const selPajak = tr.querySelector('.inp-pajak');
  const subCell  = tr.querySelector('.subtotal-cell');
  const btnDel   = tr.querySelector('.btn-delete');
  const dd       = tr.querySelector('.dd-produk');
    intOnlyInput(inpQty);
    intOnlyInput(inpHarga);
    autoSelectOnFocus(cari_mitra);
    autoSelectOnFocus(inpNama);
    autoSelectOnFocus(inpQty);
    autoSelectOnFocus(inpHarga);
    autoSelectOnFocus(inpDiskon);
    formatRupiahInput(inpHarga);
    cleanDiskonInput(inpDiskon);

  // ------------------- Dropdown Navigation State -------------------
  let activeIndex = -1;
  let currentItems = [];

  function updateHighlight(){
    currentItems.forEach(el => el.classList.remove('active-highlight'));
    if(activeIndex >= 0 && currentItems[activeIndex]){
      currentItems[activeIndex].classList.add('active-highlight');
      currentItems[activeIndex].scrollIntoView({ block:"nearest" });
    }
  }

  function moveFocus(el) {
    if (!el) return;
    setTimeout(() => {
        el.focus();
        el.select && el.select();
    }, 10);
}

inpNama.addEventListener("keydown", e => {

    // ‚Üí Pindah ke kolom qty (kode lama Anda)
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(inpQty);
        return;
    }

    // ‚¨Ü Pindah ke baris atas (jika dropdown tidak terbuka)
    if (e.key === "ArrowUp" && !dd.classList.contains("show")) {
        e.preventDefault();
        moveRowFocus(inpNama, -1);
        return;
    }

    // ‚¨á Pindah ke baris bawah (jika dropdown tidak terbuka)
    if (e.key === "ArrowDown" && !dd.classList.contains("show")) {
        e.preventDefault();
        moveRowFocus(inpNama, +1);
        return;
    }
});

inpQty.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(inpNama);
    }
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(selSatuan);
    }
    if (e.key === "ArrowUp") {
        e.preventDefault();
        moveRowFocus(inpQty, -1);
        return;
    }

    if (e.key === "ArrowDown") {
        e.preventDefault();
        moveRowFocus(inpQty, +1);
        return;
    }
});

selSatuan.addEventListener("keydown", e => {

    // ‚Üê ‚Üí tetap navigasi kolom
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(inpQty);
        return;
    }
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(inpHarga);
        return;
    }

    // Alt + Arrow ‚Üí biarkan browser membuka dropdown select
    if (e.altKey) return;

    // ENTER ‚Üí pindah ke harga
    if (e.key === "Enter") {
        e.preventDefault();
        moveFocus(inpHarga);
        return;
    }

    // ArrowUp ‚Üí pindah ke baris atas
    if (e.key === "ArrowUp") {
        e.preventDefault();
        moveRowFocus(selSatuan, -1);
        return;
    }

    // ArrowDown ‚Üí pindah ke baris bawah
    if (e.key === "ArrowDown") {
        e.preventDefault();
        moveRowFocus(selSatuan, +1);
        return;
    }
});

inpHarga.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(selSatuan);
    }
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(inpDiskon);
    }
    if (e.key === "ArrowUp") {
        e.preventDefault();
        moveRowFocus(inpHarga, -1);
        return;
    }

    if (e.key === "ArrowDown") {
        e.preventDefault();
        moveRowFocus(inpHarga, +1);
        return;
    }
});
inpDiskon.addEventListener("keydown", e => {

    // ‚Üê kiri pindah ke harga
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(inpHarga);
    }

    // ‚Üí kanan pindah ke pajak
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(selPajak);
    }
    if (e.key === "ArrowUp") {
        e.preventDefault();
        moveRowFocus(inpDiskon, -1);
        return;
    }

    if (e.key === "ArrowDown") {
        e.preventDefault();
        moveRowFocus(inpDiskon, +1);
        return;
    }

    // ‚èé ENTER ‚Üí tambah baris baru
    if (e.key === "Enter") {
        e.preventDefault();

        const nama = inpNama.value.trim();
        const q = parseInt(inpQty.value) || 0;
        const h = parseInt(inpHarga.value.replace(/\./g,'')) || 0;

        if (nama && q > 0 && h > 0) {
            addRowIfNeeded();

            // Fokus ke produk di baris baru
            setTimeout(() => {
                const last = tblBody.querySelector("tr.line-row:last-child .inp-nama");
                if (last) {
                    last.focus();
                    last.select();
                }
            }, 20);
        }
    }
});

selPajak.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(inpDiskon);
    }

});

  function autoSelectOnFocus(el) {
    if (!el) return;
    el.addEventListener("focus", () => {
        setTimeout(() => el.select && el.select(), 10);
    });
    el.addEventListener("click", () => {
        setTimeout(() => el.select && el.select(), 10);
    });
}


  // ENTER pada kolom satuan ‚Üí fokus ke harga + select value
selSatuan.addEventListener("keydown", function(e){
    if (e.key === "Enter") {
        e.preventDefault();
        setTimeout(() => {
            inpHarga.focus();
            inpHarga.select();   // blok semua angka supaya bisa langsung ketik
        }, 10);
    }
});

  // ------------------- AUTOCOMPLETE PRODUK -------------------
  let timerP = null;

  inpNama.addEventListener('input', function(){
    clearTimeout(timerP);

    const q = this.value.trim();
    this.dataset.id = "";
    activeIndex = -1;

    if(q.length < 2){
      dd.classList.remove('show');
      dd.innerHTML = "";
      return;
    }

    timerP = setTimeout(async ()=>{
      const { data } = await db.from("tb_produk")
        .select("id_produk,kode_produk,nama_produk,satuan1,satuan2,satuan3,satuan_beli")
        .or(`nama_produk.ilike.%${q}%,kode_produk.ilike.%${q}%`)
        .limit(20);

      if(!data || !data.length){
        dd.innerHTML = `<div class="dropdown-item text-muted">Tidak ada</div>`;
        dd.classList.add("show");
        return;
      }

    dd.innerHTML = "";

    data.forEach(p => {
      const a = document.createElement("a");
      a.className = "dropdown-item";

      a.dataset.id = p.id_produk;
      a.dataset.kode = p.kode_produk || "";
      a.dataset.nama = p.nama_produk;
      a.dataset.s1 = p.satuan1 || "";
      a.dataset.s2 = p.satuan2 || "";
      a.dataset.s3 = p.satuan3 || "";
      a.dataset.sb = p.satuan_beli || "";

      a.textContent =
        (p.kode_produk ? p.kode_produk + " ‚Äî " : "") + p.nama_produk;

      dd.appendChild(a);
    });

    dd.classList.add("show");

      currentItems = Array.from(dd.querySelectorAll('.dropdown-item'));
      activeIndex = -1;
    },150);
  });


  // ------------------- KEYBOARD NAVIGATION -------------------
  inpNama.addEventListener("keydown", function(e){
    if(!dd.classList.contains("show")) return;

    if(e.key === "ArrowDown"){
      e.preventDefault();
      if(currentItems.length === 0) return;
      activeIndex = (activeIndex + 1) % currentItems.length;
      updateHighlight();
    }

    else if(e.key === "ArrowUp"){
      e.preventDefault();
      if(currentItems.length === 0) return;
      activeIndex = (activeIndex - 1 + currentItems.length) % currentItems.length;
      updateHighlight();
    }

    else if(e.key === "Enter"){
      if(activeIndex >= 0 && currentItems[activeIndex]){
        e.preventDefault();
        currentItems[activeIndex].click();
      }
    }
  });

dd.addEventListener("click", function(e){
  const it = e.target.closest(".dropdown-item");
  if(!it) return;

  // ‚úÖ INPUT: NAMA SAJA
  inpNama.value = it.dataset.nama;

  // ‚úÖ ID PRODUK TETAP DISIMPAN
  inpNama.dataset.id = it.dataset.id;

  // (opsional) tooltip supaya hover tetap lihat nama lengkap
  inpNama.title =
    (it.dataset.kode ? it.dataset.kode + " ‚Äî " : "") + it.dataset.nama;


  // auto scroll (tidak wajib sekarang karena nama lebih pendek)
  setTimeout(() => {
    inpNama.scrollLeft = inpNama.scrollWidth;
  }, 0);

  // isi satuan
  selSatuan.innerHTML = '<option value="">Pilih Satuan</option>';
  if(it.dataset.s1) selSatuan.add(new Option(it.dataset.s1, it.dataset.s1));
  if(it.dataset.s2) selSatuan.add(new Option(it.dataset.s2, it.dataset.s2));
  if(it.dataset.s3) selSatuan.add(new Option(it.dataset.s3, it.dataset.s3));

  selSatuan.value = it.dataset.sb || it.dataset.s1 || "";

  dd.classList.remove("show");

  setTimeout(()=>{
    inpQty.focus();
    inpQty.select();
  },20);
});




  // ------------------- CLICK OUTSIDE HIDE DROPDOWN -------------------
  document.addEventListener("click", (ev)=>{
    if(!tr.contains(ev.target)) dd.classList.remove("show");
  });



  // ------------------- RECALC -------------------
function recalc(){
  const q = parseInt(inpQty.value) || 0;
  // harga input mungkin berformat "100.000" -> hapus titik
  const h = parseInt((inpHarga.value||'').toString().replace(/\./g,'')) || 0;
  const base = q * h; // total sebelum diskon

  const rawDiskon = (inpDiskon.value||'').toString().trim();
  let discTotal = parseDiskon(rawDiskon, q, h);

  if(discTotal > base) discTotal = base;

  // hitung pajak berdasarkan taxable = base - discTotal
  const taxRate = TAX_RATES[selPajak.value] || 0;
  const taxable = base - discTotal;
  const taxAmount = Math.round(taxable * taxRate);

  const subtotal = taxable + taxAmount;
  subCell.innerText = fmt(subtotal);

  // jika mau tampilkan diskon per baris di kolom diskon Rp terpisah, bisa set value:
  // const perUnitDisc = Math.floor(discTotal / Math.max(1,q));
  // jika ada kolom diskon-rp, isi dengan fmt(perUnitDisc);

  refreshTotals();
}

  inpQty.addEventListener('input', recalc);
  inpHarga.addEventListener('input', recalc);
  inpDiskon.addEventListener('input', ()=> {
  // allow only digits, dot, percent and plus
  let v = (inpDiskon.value || '').toString();
  v = v.replace(/[^\d+.%]/g, '');               // hanya 0-9 + . % dan +
  v = v.replace(/\++/g, '+');                   // ganti "+++" jadi "+"
  v = v.replace(/(\.%|%\.)/g, '%');             // bersihkan kombinasi aneh
  inpDiskon.value = v;
  recalc();
});

inpDiskon.addEventListener('blur', e=>{
  let v = (e.target.value||'').toString().trim();
  if(!v) return;

  if(v.endsWith('%')){
    // biarkan "10%" atau "10%+5%"
    // kita normalisasi tiap part: if numeric <100 and no % sign, we keep as-is
    // nothing to auto-convert here
    inpDiskon.value = v;
    return;
  }

  // jika berisi '+' -> format tiap bagian nominal jika bukan persen
  if(v.includes('+')){
    const parts = v.split('+').map(p => p.trim()).map(p=>{
      if(p.endsWith('%')) return p;
      // remove existing dots then format with dots
      const n = parseInt(p.replace(/\./g,'')) || 0;
      return n === 0 ? '' : fmt(n);
    }).filter(Boolean);
    inpDiskon.value = parts.join('+');
    return;
  }

  // jika hanya angka -> anggap nominal per unit, format dengan titik (1000 -> 1.000)
  const onlyNum = v.replace(/\./g,'').replace(/,/g,'');
  if(/^\d+$/.test(onlyNum)){
    const num = parseInt(onlyNum) || 0;
    // jika kurang dari 100 mungkin pengguna maksud persen ‚Äî kalau ingin auto-convert uncomment:
    // if(num < 100){ inpDiskon.value = num + '%'; recalc(); return; }
    inpDiskon.value = num === 0 ? '' : fmt(num);
    return;
  }
});
  selPajak.addEventListener('change', recalc);

  // ------------------- ENTER ON HARGA = TAMBAH BARIS -------------------
  inpHarga.addEventListener("keydown", e=>{
    if(e.key === "Enter"){
      e.preventDefault();

      if(inpNama.value.trim() !== "" && parseInt(inpQty.value)>0 && parseInt(inpHarga.value)>0){
        addRowIfNeeded();
        setTimeout(()=>{
          const last = tblBody.querySelector('tr.line-row:last-child .inp-nama');
          if(last) last.focus();
        },20);
      }
    }
  });

  // ------------------- DELETE ROW -------------------
  btnDel.addEventListener("click", ()=>{
    tr.remove();
    refreshRowNumbers();
    refreshTotals();
    addRowIfNeeded();
  });
}

// ===================== ADD ROW IF NEEDED =====================
function addRowIfNeeded(){
  const rows = Array.from(tblBody.querySelectorAll('tr.line-row'));
  const last = rows[rows.length-1];

  if(!last ||
     last.querySelector('.inp-nama').value.trim() !== "" ||
     parseInt(last.querySelector('.inp-harga').value) > 0){

    tblBody.appendChild(createRow());
  }

  refreshRowNumbers();
}

// ==================== ROW NUMBERING =====================
function refreshRowNumbers(){
  Array.from(tblBody.querySelectorAll('tr.line-row')).forEach((r,i)=>{
    const noCell = r.querySelector('.line-no');
    if(noCell) noCell.innerText = i+1;
  });
}

// ===================== INITIALIZE FIRST ROW =====================
if(!tblBody.querySelector('tr.line-row')){
  tblBody.appendChild(createRow());
}

// ===================== TOTALS =====================
function refreshTotals(){
  const rows = Array.from(tblBody.querySelectorAll('tr.line-row'));
  let sub = 0;

  rows.forEach(r=>{
    sub += toNum(r.querySelector('.subtotal-cell').innerText);
  });

  subTxt.innerText = fmt(sub);
  const dt = toNum(diskon_total.value);
  const bl = toNum(biaya_lain.value);
  const grand = sub - dt + bl;
  grandTxt.innerText = fmt(grand);
}

diskon_total.addEventListener('input', refreshTotals);
biaya_lain.addEventListener('input', refreshTotals);

// ===================== GATHER ITEMS =====================
function gatherItemsFromTable(){
  const items = [];

  Array.from(tblBody.querySelectorAll('.line-row')).forEach(r=>{
    const nama = r.querySelector('.inp-nama').value.trim();
    if(!nama) return;

    const id_produk = r.querySelector('.inp-nama').dataset.id || null;
    const qty = parseInt(r.querySelector('.inp-qty').value) || 0;
    const satuan = r.querySelector('.inp-satuan').value || '';
    const harga = parseInt(
      (r.querySelector('.inp-harga').value || '').replace(/\./g,'')
    ) || 0;
    const rawDiskon = r.querySelector('.inp-diskon').value.trim();
    const diskon_rp = parseDiskon(rawDiskon, qty, harga);

    const pajak = r.querySelector('.inp-pajak').value || 'NO';
    const subtotal = toNum(r.querySelector('.subtotal-cell').innerText);

    items.push({
      id_produk,
      nama_item: nama,
      qty,
      satuan,
      harga,
      diskon_item: diskon_rp,
      subtotal,
      pajak
    });
  });

  return items;
}

async function confirmHargaNol() {
    const rows = Array.from(tblBody.querySelectorAll("tr.line-row"));
    let adaHargaNol = false;
    let pesan = "";

    rows.forEach((r, i) => {
        const nama = r.querySelector(".inp-nama").value.trim();
        const harga = parseInt((r.querySelector(".inp-harga").value || "").replace(/\./g, "")) || 0;

        if (!nama) return; // skip baris kosong

        if (harga === 0) {
            soundError();
            adaHargaNol = true;
            pesan += `- No ${i + 1} (${nama}) harganya 0\n`;
        }
    });

    if (!adaHargaNol) return true;

    // Konfirmasi
    return confirm(
        "Terdapat harga 0:\n\n" +
        pesan +
        "\nApakah Anda yakin ingin melanjutkan?"
    );

}

// ===================== SAVE =====================
btnSave.addEventListener("click", async function(e){
  e.preventDefault();


  try {
    if (!AKUN_PERSEDIAAN) {
      throw new Error("Setting akun persediaan belum tersedia");
    }
    if (termin.value === "cash" && !pembayaran.value) {
      soundError();
      throw new Error("Pilih akun pembayaran terlebih dahulu");
    }
    btnSave.disabled = true;
    btnSave.innerHTML = "Menyimpan...";

    const items = gatherItemsFromTable();
    if (items.length === 0) throw new Error("Item kosong");

    const sub = items.reduce((s,i)=>s+i.subtotal,0);
    const dt = toNum(diskon_total.value);
    const bl = toNum(biaya_lain.value);
    const grand = sub - dt + bl;

    const t_jatuh =
      termin.value === "credit" && tempo.value > 0
        ? new Date(new Date(tanggal.value).getTime() + tempo.value * 86400000)
            .toISOString().slice(0,10)
        : null;

    // üî• rollback dulu
    await rollbackPembelianLama();

    // üîÑ update header
    await db.from("tb_pembelian")
      .update({
        tanggal: tanggal.value,
        id_mitra: cari_mitra.dataset.id,
        termin: termin.value,
        tempo: tempo.value,
        tanggal_jatuh_tempo: t_jatuh,
        total_sub: sub,
        total_diskon: dt,
        total_biaya_lain: bl,
        grand_total: grand
      })
      .eq("id_pembelian", ID_PEMBELIAN);

    // ‚ûï insert ulang detail
    await db.from("tb_pembelian_detail").insert(
      items.map(it => ({
        id_pembelian: ID_PEMBELIAN,
        id_produk: it.id_produk,
        nama_item: it.nama_item,
        qty: it.qty,
        satuan: it.satuan,
        harga: it.harga,
        diskon_item: it.diskon_item,
        subtotal: it.subtotal
      }))
    );

    // ‚ûï mutasi stok
    await db.from("tb_stock_mutasi").insert(
      items.filter(i=>i.id_produk).map(it => ({
        id_produk: it.id_produk,
        sumber: "pembelian",
        ref_id: ID_PEMBELIAN,
        tanggal: tanggal.value,
        qty: it.qty,
        satuan: it.satuan,
        keterangan: `Edit Pembelian ${kode.value}`
      }))
    );

    // ===================== INSERT JURNAL BARU =====================
    const jurnalKet = `Edit Pembelian ${kode.value}`;
    const { data: jurnalHead, error: jErr } = await db
      .from("tb_jurnal")
      .insert([{
        tanggal: tanggal.value,
        sumber: "pembelian",
        id_source: ID_PEMBELIAN,
        keterangan: jurnalKet
      }])
      .select()
      .single();

    if (jErr) throw jErr;

    const idJurnal = jurnalHead.id_jurnal;

    // =======INSERT JURNAL DETAIL 
    let akunKredit = "";
    if (termin.value === "cash") {
      akunKredit = kasbankMap[pembayaran.value];
    } else {
      akunKredit = cari_mitra.dataset.akun_hutang;
    }

    if (!akunKredit) {
      throw new Error("Akun kredit tidak ditemukan. Cek pembayaran / akun hutang.");
    }   

    const jurnalDetail = [
      {
        id_jurnal: idJurnal,
        kode_akun: AKUN_PERSEDIAAN,
        debit: grand,
        kredit: 0
      },
      {
        id_jurnal: idJurnal,
        kode_akun: akunKredit,
        debit: 0,
        kredit: grand
      }
    ];

    const { error: jdErr } = await db
      .from("tb_jurnal_detail")
      .insert(jurnalDetail);

    if (jdErr) throw jdErr;

    // ======insert jurnal jika kredit
    if (termin.value === "credit") {
      const { error: htgErr } = await db
        .from("tb_hutang")
        .insert([{
          id_pembelian: ID_PEMBELIAN,
          id_mitra: cari_mitra.dataset.id,
          total: grand,
          sisa: grand,
          jatuh_tempo: t_jatuh,
          status: "open"
        }]);

      if (htgErr) throw htgErr;
    }

    alert("Pembelian berhasil diperbarui");
    location.href = "h_pembelian_tab.html";

  } catch(err){
    console.error(err);
    alert(err.message);
  } finally {
    btnSave.disabled = false;
    btnSave.innerHTML = "Simpan";
  }
});
// END SAVE

// ===================== CTRL + ENTER SUBMIT =====================
document.addEventListener("keydown", e=>{
  if(e.ctrlKey && e.key==="Enter"){
    e.preventDefault();
    btnSave.click();
  }
});

// ===================== ENTER NAVIGATION FORM (di luar table) =====================
document.getElementById('form').addEventListener('keydown', function(e){
  if(e.key==='Enter' && !e.ctrlKey && !e.target.classList.contains('inp-harga')){
    e.preventDefault();

    const idx = Array.prototype.indexOf.call(this, e.target);
    if(this.elements[idx+1])
        this.elements[idx+1].focus();
  }
});
termin.addEventListener("change", () => {
  if (termin.value === "credit" && !cari_mitra.dataset.id) {
    soundError();
    alert("Pilih supplier terlebih dahulu sebelum memilih CREDIT");
    termin.value = "cash";
    tempo.value = 0;
    tempo.setAttribute("disabled","disabled");
    return;
  }

  if (termin.value === 'cash') {
    tempo.value = 0;
    tempo.setAttribute('disabled', 'disabled');
} else {
  tempo.removeAttribute('disabled');

  // üî• PRIORITAS:
  // 1. tempo pembelian lama
  // 2. tempo supplier
  // 3. fallback 0
  tempo.value =
    originalTempoPembelian > 0
      ? originalTempoPembelian
      : (parseInt(cari_mitra.dataset.tempo || "0") || 0);
}
  updateTerminUI();
  updateJatuhTempo();
});

// ===================== INITIALIZE =====================
(async function initEdit(){
  await preloadSettingAkun();
  await loadKasBank();              // wajib dulu
  await loadPembelianHeader();      // isi termin & supplier
  await restorePembayaranCashFromJurnal(); // üî• INI TAMBAHAN PENTING
  await loadPembelianDetail();
})();
</script>
</body>
</html>
