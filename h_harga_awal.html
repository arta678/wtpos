<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Saldo Harga Awal</title>
    <link rel="icon" href="img/logo.svg">
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/noscroll.css">
    <style>
.dropdown-menu.show {
    display:block;
    max-height:200px;
    overflow-y:auto;
    cursor:pointer;
}
.input-error {
    border: 1px solid #dc3545 !important; /* merah bootstrap */
    box-shadow: 0 0 4px rgba(220,53,69,0.4) !important;
}
#dropdown_kategori.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
#dropdown_merek.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
.dropdown-item.active-highlight {
    background-color: #007bff !important;
    color: white !important;
}
.shortcut-menu {
    gap: 10px;
    margin-top: 45px !important; /* turun dari 70 px → lebih dekat ke navbar */
}

.shortcut-item {
    width: 55px; /* dari 70px */
    text-align: center;
    text-decoration: none !important;
}

.shortcut-icon {
    width: 38px;   /* dari 50px */
    height: 38px;  /* dari 50px */
    border-radius: 10px; /* sedikit lebih kecil */
    font-size: 16px;     /* dari 20px */
    display: flex;
    justify-content: center;
    align-items: center;
    margin: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.shortcut-text {
    margin-top: 4px;
    font-size: 11px; /* dari 12px */
    color: #444;
}
.form-horizontal .form-group {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}
 
.form-horizontal label {
    width: 110px; /* lebar label (bisa diubah) */
    margin-bottom: 0;
    font-size: 13px;
    color: #333;
}

.form-horizontal .form-control,
.form-horizontal .form-select {
    flex: 1;
}
/* Agar wrapper kategori/merek ikut aturan flex dan ukurannya sama dgn input lainnya */
.form-horizontal .form-group > .position-relative {
    flex: 1;                       /* wajib */
    display: flex;                 /* biar textarea/input di dalamnya ikut full */
    align-items: center;
}

.form-horizontal .position-relative input.form-control-sm {
    width: 100%;                   /* pastikan penuh */
}
.gap-2 > * {
    margin-left: 6px;
}
.table thead th {
    background: linear-gradient(to bottom, #f5f5f5, #ededee);
    color: #7789bf;
    font-weight: 600;
    border-bottom: 2px solid #ffffff;
}
.card-body {
    padding-bottom: 0 !important;
}
.card-body nav {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
}
#pagination {
    margin: 0 !important;
    padding: 0 !important;
}
/* HANYA BARIS DATA (ISI TABEL) */
.table-tight tbody td {
    padding-top: 2px !important;
    padding-bottom: 2px !important;
    line-height: 1.15;
    vertical-align: middle;
}
.action-icon {
    cursor: pointer;
    padding: 2px;
}
tr.barisdata:hover { background:#f1f5ff; cursor:pointer }
td[contenteditable]{
  cursor:text;
}
td[contenteditable]:focus{
  outline:none;
  background:#fff8e1;
}
td.changed{
  background:#e3f2fd !important;
}
.table thead th{
  background:#f5f6fa;
}
.text-mono{
  font-family:monospace;
}
.table-wrap{
  max-width: 600px;   /* bebas: 600px / 800px */
}
</style>
</head>
<body id="page-top">
<div id="navbar"></div>
<div id="wrapper">
<div id="content-wrapper" class="d-flex flex-column">
<div id="content">
<div class="container-fluid">    
  <div id="shortcut"></div>
    <div class="card shadow mb-4"> 
      <div class="card-header d-flex justify-content-between align-items-center py-2 flex-wrap">
          <h6 class="m-0 font-weight-bold text-primary">Merek</h6>
          <span id="offlineBadge" class="badge badge-warning d-none">Offline</span>
          <div class="d-flex align-items-center gap-2 mt-2 mt-md-0">
              <button class="btn btn-sm btn-primary" onclick="simpanHpp()">
                <i class="fas fa-save"></i> Simpan Perubahan
              </button>
          </div>
      </div>
      <div class="card-body table-responsive d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <table class="table table-hover table-sm table-bordered table-tight">
        <thead>
          <tr>
            <th width="50px">Kode</th>
            <th>Nama</th>
            <th class="text-right">HPP Awal</th>
          </tr>
        </thead>
        <tbody id="tbHpp"></tbody>
    </table>
    <nav>
      <ul class="pagination justify-content-center" id="pagination">
        <li class="page-item">
          <a class="page-link" href="#" onclick="prevPage()">&laquo;</a>
      </li>

      <li class="page-item disabled">
          <a class="page-link" href="#">
            Halaman <span id="page-number">1</span>
        </a>
    </li>
    <li class="page-item">
      <a class="page-link" href="#" onclick="nextPage()">&raquo;</a>
  </li>
</ul>
</nav>
</div>
</div>
</div>
</div>
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>
<script src="js/navbar_on_off.js"></script>
<script>
function initNavbarQuickSearch() {
  const nav = document.getElementById("navbar");
  if (!nav) return;
  const input = nav.querySelector("#quickSearchInput");
  if (!input || input.dataset.bound) return;
  input.dataset.bound = "1";
  input.addEventListener("keydown", e => {
    if (e.key !== "Enter") return;
    e.preventDefault();
    const q = input.value.trim();
    if (!q) return;
    location.href =
      "h_harga_produk.html?q=" + encodeURIComponent(q);
  });
}
async function loadNavbar() {
  const navEl = document.getElementById("navbar");
  if (localStorage.getItem("navbar")) {
    navEl.innerHTML = localStorage.getItem("navbar");
    navEl.classList.add("loaded");
  }
  const res = await fetch("navbar.html");
  const html = await res.text();
  localStorage.setItem("navbar", html);
  navEl.innerHTML = html;
  navEl.classList.add("loaded");
  if (typeof applyShortcutVisibility === "function") {
    applyShortcutVisibility();
  }
  initNavbarQuickSearch();
}
async function loadShortcut() {
  if (!isShortcutEnabled()) {
    const el = document.getElementById("shortcut");
    if (el) el.style.display = "none";
    return;
  }

  const el = document.getElementById("shortcut");

  if (localStorage.getItem("shortcut_html")) {
    el.innerHTML = localStorage.getItem("shortcut_html");
    applyShortcutIcons(); // ⬅️ WAJIB
  }

  const res = await fetch("shortcut.html");
  const html = await res.text();

  localStorage.setItem("shortcut_html", html);
  el.innerHTML = html;

  applyShortcutIcons(); // ⬅️ WAJIB
}

loadNavbar();
loadShortcut();
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/db_supabase.js"></script>

<script>
let page = 1;
const perPage = 15;
let totalPages = 1;
let totalRows = 0; 
// ================= HELPER =================
function fmt(n){
  return (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.');
}
function toNum(s){
  return parseFloat((s||"").toString().replace(/\./g,'')) || 0;
}

// ================= LOAD DATA =================
async function loadHpp() {

  const from = (page - 1) * perPage;
  const to = from + perPage - 1;

  const { data, count, error } = await db
    .from("tb_produk")
    .select(
      `
      id_produk,
      kode_produk,
      nama_produk,
      hpp_awal
      `,
      { count: "exact" }   // ⬅️ INI KUNCI TOTAL PAGE
    )
    .order("nama_produk")
    .range(from, to);

  if (error) {
    alert("Gagal load data HPP");
    console.error(error);
    return;
  }

  totalRows = count || 0;
  totalPages = Math.ceil(totalRows / perPage);

  // proteksi page
  if (page > totalPages) page = totalPages || 1;
  if (page < 1) page = 1;

  renderHpp(data || []);
  updatePagination();
}


function renderHpp(list) {
  if (!list || list.length === 0) {
    document.getElementById("tbHpp").innerHTML = `
      <tr>
        <td colspan="3" class="text-center text-muted py-3">
          Tidak ada data
        </td>
      </tr>`;
    return;
  }

  document.getElementById("tbHpp").innerHTML = list.map(p => `
    <tr data-id="${p.id_produk}" class="barisdata">
      <td class="text-mono">${p.kode_produk || ""}</td>
      <td>${p.nama_produk}</td>
      <td class="text-right"
          contenteditable
          data-field="hpp_awal">${fmt(p.hpp_awal || 0)}</td>
    </tr>
  `).join("");
}

function nextPage() {
  if (page >= totalPages) return;
  page++;
  loadHpp();
}

function prevPage() {
  if (page <= 1) return;
  page--;
  loadHpp();
}

function updatePagination() {
  document.getElementById("page-number").innerText = page;

  document.querySelector("#pagination li:first-child")
    .classList.toggle("disabled", page <= 1);

  document.querySelector("#pagination li:last-child")
    .classList.toggle("disabled", page >= totalPages);
}


// ================= FORMAT + TRACK CHANGE =================
document.addEventListener("input", e=>{
  if(!e.target.matches("td[contenteditable]")) return;
  e.target.classList.add("changed");
});

document.addEventListener("blur", e=>{
  if(!e.target.matches("td[contenteditable]")) return;

  const raw = e.target.innerText.replace(/\D/g,"");
  const val = toNum(raw);
  e.target.innerText = fmt(val);
}, true);

// ================= SAVE =================
async function simpanHpp(){
  const rows = [];

  document.querySelectorAll("td.changed").forEach(td=>{
    const tr = td.closest("tr");
    rows.push({
      id_produk: tr.dataset.id,
      hpp_awal: toNum(td.innerText)
    });
  });

  if(!rows.length){
    alert("Tidak ada perubahan");
    return;
  }

  const { error } = await db
    .from("tb_produk")
    .upsert(rows, { onConflict: "id_produk" });

  if(error){
    alert("Gagal menyimpan HPP Awal");
    console.error(error);
    return;
  }

  document.querySelectorAll(".changed")
    .forEach(td=>td.classList.remove("changed"));

  alert("HPP awal berhasil disimpan");
}

// ================= INIT =================
loadHpp();
</script>
</body>
</html>
