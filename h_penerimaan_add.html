<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Aplikasi Wiguna Teknik</title>
    <!-- Custom fonts for this template-->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
    href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
    rel="stylesheet">
    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/noscroll.css">
    <style>
.dropdown-menu.show {
    display:block;
    max-height:200px;
    overflow-y:auto;
    cursor:pointer;
}
.input-error {
    border: 1px solid #dc3545 !important; /* merah bootstrap */
    box-shadow: 0 0 4px rgba(220,53,69,0.4) !important;
}
#dropdown_kategori.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
#dropdown_merek.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
.dropdown-item.active-highlight {
    background-color: #007bff !important;
    color: white !important;
}
</style>
</head>
<body id="page-top" class="sidebar-toggled">
    <div id="wrapper">
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion toggled" id="accordionSidebar">
            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-laugh-wink"></i>
                </div>
                <div class="sidebar-brand-text mx-3">WIGUNA T</div>
            </a>
            <!-- Divider -->
            <hr class="sidebar-divider my-0">
            <!-- Nav Item - Dashboard -->
            <li class="nav-item active">
                <a class="nav-link" href="#">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span></a>
                </li>
                <hr class="sidebar-divider">
                <li class="nav-item active">
                    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                    aria-expanded="true" aria-controls="collapseTwo">
                    <i class="fas fa-database"></i>
                    <span>Data</span>
                </a>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <a class="collapse-item" href="h_produk_tab.html">Produk</a>
                        <a class="collapse-item" href="h_merek_tab.html">Merek</a>
                        <a class="collapse-item" href="h_kategori_tab.html">Kategori Produk</a>
                        <a class="collapse-item" href="#">Daftar Harga</a>
                        <a class="collapse-item" href="#">Stok Produk</a>
                    </div>
                </div>
            </li>
            <li class="nav-item active">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
                aria-expanded="true" aria-controls="collapseUtilities">
                <i class="fas fa-cart-arrow-down"></i>
                <span>Transaksi</span>
            </a>
            <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
            data-parent="#accordionSidebar">
            <div class="bg-white py-2 collapse-inner rounded">
                <a class="collapse-item" href="#">Pembelian</a>
                <a class="collapse-item" href="#">Penjualan</a>
                <a class="collapse-item" href="#">Orderan Produk</a>
                <a class="collapse-item" href="#">Retur</a>
            </div>
        </div>
    </li>
    <li class="nav-item active">
        <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collap_mitra_bisnis"
        aria-expanded="true" aria-controls="collap_mitra_bisnis">
        <i class="fas fa-users"></i>
        <span>Mitra Bisnis</span>
    </a>
    <div id="collap_mitra_bisnis" class="collapse" aria-labelledby="headingUtilities"
    data-parent="#accordionSidebar">
            <div class="bg-white py-2 collapse-inner rounded">
                <a class="collapse-item" href="h_mitra_tab_customer.html">Customer</a>
                <a class="collapse-item" href="h_mitra_tab_supplier.html">Supplier</a>
                <a class="collapse-item" href="h_mitra_tab_grup.html">Grup Mitra Bisnis</a>
            </div>
</div>
</li>
<li class="nav-item active">
    <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collap_laporan"
    aria-expanded="true" aria-controls="collap_laporan">
    <i class="fas fa-chart-line"></i>
    <span>Laporan</span>
</a>
<div id="collap_laporan" class="collapse" aria-labelledby="headingUtilities"
data-parent="#accordionSidebar">
<div class="bg-white py-2 collapse-inner rounded">
    <a class="collapse-item" href="#">Pembelian</a>
    <a class="collapse-item" href="#">Penjualan</a>
    <a class="collapse-item" href="#">Stok</a>
</div>
</div>
</li>
<!-- Divider -->
<hr class="sidebar-divider d-none d-md-block">
<!-- Sidebar Toggler (Sidebar) -->
<div class="text-center d-none d-md-inline">
    <button class="rounded-circle border-0" id="sidebarToggle"></button>
</div>
</ul>
<!-- CONTENT -->
<div id="content-wrapper" class="d-flex flex-column">
    <div id="content">
        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
            <!-- Sidebar Toggle (Topbar) -->
            <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                <i class="fa fa-bars"></i>
            </button>
            <!-- Topbar Search -->
            <form
            class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
            <div class="input-group">
                <input type="text" class="form-control bg-light border-0 small" placeholder="Search for..."
                aria-label="Search" aria-describedby="basic-addon2">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button">
                        <i class="fas fa-search fa-sm"></i>
                    </button>
                </div>
            </div>
        </form>
        <!-- Topbar Navbar -->
        <ul class="navbar-nav ml-auto">

            <!-- Nav Item - Search Dropdown (Visible Only XS) -->
            <li class="nav-item dropdown no-arrow d-sm-none">
                <a class="nav-link dropdown-toggle" href="#" id="searchDropdown" role="button"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-search fa-fw"></i>
            </a>
            <!-- Dropdown - Messages -->
            <div class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in"
            aria-labelledby="searchDropdown">
            <form class="form-inline mr-auto w-100 navbar-search">
                <div class="input-group">
                    <input type="text" class="form-control bg-light border-0 small"
                    placeholder="Search for..." aria-label="Search"
                    aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="button">
                            <i class="fas fa-search fa-sm"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </li>
    <!-- Nav Item - Alerts -->
    <li class="nav-item dropdown no-arrow mx-1">
        <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button"
        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <i class="fas fa-bell fa-fw"></i>
        <!-- Counter - Alerts -->
        <span class="badge badge-danger badge-counter">3+</span>
    </a>
    <!-- Dropdown - Alerts -->
    <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
    aria-labelledby="alertsDropdown">
    <h6 class="dropdown-header">
        Alerts Center
    </h6>
    <a class="dropdown-item d-flex align-items-center" href="#">
        <div class="mr-3">
            <div class="icon-circle bg-primary">
                <i class="fas fa-file-alt text-white"></i>
            </div>
        </div>
        <div>
            <div class="small text-gray-500">December 12, 2019</div>
            <span class="font-weight-bold">A new monthly report is ready to download!</span>
        </div>
    </a>
    <a class="dropdown-item d-flex align-items-center" href="#">
        <div class="mr-3">
            <div class="icon-circle bg-success">
                <i class="fas fa-donate text-white"></i>
            </div>
        </div>
        <div>
            <div class="small text-gray-500">December 7, 2019</div>
            $290.29 has been deposited into your account!
        </div>
    </a>
    <a class="dropdown-item d-flex align-items-center" href="#">
        <div class="mr-3">
            <div class="icon-circle bg-warning">
                <i class="fas fa-exclamation-triangle text-white"></i>
            </div>
        </div>
        <div>
            <div class="small text-gray-500">December 2, 2019</div>
            Spending Alert: We've noticed unusually high spending for your account.
        </div>
    </a>
    <a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a>
</div>
</li>
<!-- Nav Item - Messages -->
<li class="nav-item dropdown no-arrow mx-1">
    <a class="nav-link dropdown-toggle" href="#" id="messagesDropdown" role="button"
    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <i class="fas fa-envelope fa-fw"></i>
    <!-- Counter - Messages -->
    <span class="badge badge-danger badge-counter">7</span>
</a>
<!-- Dropdown - Messages -->
<div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
aria-labelledby="messagesDropdown">
<h6 class="dropdown-header">
    Message Center
</h6>
<a class="dropdown-item d-flex align-items-center" href="#">
    <div class="dropdown-list-image mr-3">
        <img class="rounded-circle" src="img/undraw_profile_1.svg"
        alt="...">
        <div class="status-indicator bg-success"></div>
    </div>
    <div class="font-weight-bold">
        <div class="text-truncate">Hi there! I am wondering if you can help me with a
        problem I've been having.</div>
        <div class="small text-gray-500">Emily Fowler · 58m</div>
    </div>
</a>
<a class="dropdown-item d-flex align-items-center" href="#">
    <div class="dropdown-list-image mr-3">
        <img class="rounded-circle" src="img/undraw_profile_2.svg"
        alt="...">
        <div class="status-indicator"></div>
    </div>
    <div>
        <div class="text-truncate">I have the photos that you ordered last month, how
        would you like them sent to you?</div>
        <div class="small text-gray-500">Jae Chun · 1d</div>
    </div>
</a>
<a class="dropdown-item d-flex align-items-center" href="#">
    <div class="dropdown-list-image mr-3">
        <img class="rounded-circle" src="img/undraw_profile_3.svg"
        alt="...">
        <div class="status-indicator bg-warning"></div>
    </div>
    <div>
        <div class="text-truncate">Last month's report looks great, I am very happy with
        the progress so far, keep up the good work!</div>
        <div class="small text-gray-500">Morgan Alvarez · 2d</div>
    </div>
</a>
<a class="dropdown-item d-flex align-items-center" href="#">
    <div class="dropdown-list-image mr-3">
        <img class="rounded-circle" src="https://source.unsplash.com/Mv9hjnEUHR4/60x60"
        alt="...">
        <div class="status-indicator bg-success"></div>
    </div>
    <div>
        <div class="text-truncate">Am I a good boy? The reason I ask is because someone
        told me that people say this to all dogs, even if they aren't good...</div>
        <div class="small text-gray-500">Chicken the Dog · 2w</div>
    </div>
</a>
<a class="dropdown-item text-center small text-gray-500" href="#">Read More Messages</a>
</li>
<div class="topbar-divider d-none d-sm-block"></div>
<!-- Nav Item - User Information -->
<li class="nav-item dropdown no-arrow">
    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    <span class="mr-2 d-none d-lg-inline text-gray-600 small">Douglas McGee</span>
    <img class="img-profile rounded-circle"
    src="img/undraw_profile.svg">
</a>
<!-- Dropdown - User Information -->
<div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
aria-labelledby="userDropdown">
<a class="dropdown-item" href="#">
    <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
    Profile
    </a>
    <a class="dropdown-item" href="#">
        <i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i>
        Settings
    </a>
    <a class="dropdown-item" href="#">
        <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
        Activity Log
    </a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
        <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
        Logout
    </a>
    </div>
    </li>
    </ul>
    </nav>
    <div class="container-fluid">
        <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
                <a class="nav-link active" href="h_produk_tab.html">Produk</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="h_merek_tab.html">Merek</a>
            </li>
            <li class="nav-item">
                <a class="nav-link " href="h_kategori_tab.html">Kategori</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="h_harga_tab.html">Daftar Harga</a>
            </li>
        </ul>
        <div class="card shadow mb-4">
          <div class="card-body">
      <form id="form">

        <div class="form-row">
          <div class="col-md-3 mb-2">
            <label>Tanggal</label>
            <input type="date" id="tanggal" class="form-control">
          </div>

          <div class="col-md-4 mb-2">
            <label>Rekening (Kas/Bank)</label>
            <select id="id_kasbank" class="form-control"></select>
          </div>

          <div class="col-md-3 mb-2">
            <label>Metode Pembayaran</label>
            <select id="metode" class="form-control">
              <option value="tunai">TUNAI</option>
              <option value="transfer">TRANSFER</option>
              <option value="qris">QRIS (GoPay Merchant)</option>
            </select>
          </div>

        </div>

        <div class="form-row">

          <div class="col-md-4 mb-2">
            <label>Nominal (Rp)</label>
            <input id="nominal" autocomplete="off" class="form-control">
          </div>

          <div class="col-md-4 mb-2">
            <label>MDR (Rp)</label>
            <input id="mdr" disabled class="form-control">
          </div>

          <div class="col-md-4 mb-2">
            <label>Diterima (Net)</label>
            <input id="net" disabled class="form-control">
          </div>

        </div>

        <div class="form-row">

          <div class="col-md-6 mb-2">
            <label>Akun Lawan (Pendapatan / Piutang / Dll)</label>
            <input id="cari_akun" class="form-control" placeholder="Cari akun (≥ 3 huruf)">
            <div id="dropdown_akun" class="dropdown-menu w-100"></div>
          </div>

          <div class="col-md-6 mb-2">
            <label>Referensi / No. Bukti</label>
            <input id="referensi" class="form-control">
          </div>

        </div>

        <div class="form-row">

          <div class="col-md-12 mb-2">
            <label>Keterangan</label>
            <textarea id="keterangan" class="form-control" rows="2"></textarea>
          </div>

        </div>

        <button id="btn" class="btn btn-primary" type="submit">
          Simpan
        </button>

        <a href="h_penerimaan_tab.html" class="btn btn-secondary ml-2">Batal</a>

         </form>
          </div>
        </div>
    </div>
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/db_supabase.js"></script>
<script>
function rupiahInput(el) {
  el.addEventListener("input", () => {
    el.value = el.value.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  });
}
function toAngka(str) {
  return parseInt((str || "").replace(/\./g, "") || "0");
}
rupiahInput(document.getElementById("nominal"));


// ------------------ LOAD KASBANK ------------------
async function loadKasbank() {
  const sel = document.getElementById("id_kasbank");
  const { data } = await db.from("tb_kasbank").select("*").order("nama_rekening");

  sel.innerHTML = "";
  data.forEach(r => {
    sel.innerHTML += `<option value="${r.id_kasbank}" data-akun="${r.kode_akun}">
      ${r.nama_rekening} ${r.nama_bank ? "- " + r.nama_bank : ""}
    </option>`;
  });
}
loadKasbank();


// ------------------ AKUN LAWAN SEARCH ------------------
let timerAkun = null;
let akunIndex = -1;
const inpAkun = document.getElementById("cari_akun");
const ddAkun = document.getElementById("dropdown_akun");

inpAkun.addEventListener("input", function () {
  inpAkun.dataset.kode = "";
  clearTimeout(timerAkun);

  const kw = this.value.trim();
  if (kw.length < 3) {
    ddAkun.classList.remove("show");
    return;
  }
  ddAkun.classList.add("show");

  timerAkun = setTimeout(async () => {
    const { data } = await db
      .from("tb_akun")
      .select("kode_akun,nama_akun")
      .ilike("nama_akun", `%${kw}%`)
      .limit(10);

    if (!data || data.length === 0) {
      ddAkun.innerHTML = `<div class="dropdown-item text-muted">Tidak ada hasil</div>`;
      return;
    }

    ddAkun.innerHTML = data
      .map(
        a => `<div class="dropdown-item" data-kode="${a.kode_akun}" data-nama="${a.nama_akun}">
                ${a.kode_akun} — ${a.nama_akun}
              </div>`
      )
      .join("");
  }, 300);
});

ddAkun.addEventListener("click", e => {
  const item = e.target.closest(".dropdown-item");
  if (!item) return;

  inpAkun.value = `${item.dataset.kode} — ${item.dataset.nama}`;
  inpAkun.dataset.kode = item.dataset.kode;
  ddAkun.classList.remove("show");
});


// ------------------ AKUN LAWAN KEYBOARD ------------------
inpAkun.addEventListener("keydown", function (e) {
  const items = ddAkun.querySelectorAll(".dropdown-item");
  if (!ddAkun.classList.contains("show")) return;

  if (e.key === "ArrowDown") {
    e.preventDefault();
    akunIndex = (akunIndex + 1) % items.length;
    highlight(items, akunIndex);
  }
  if (e.key === "ArrowUp") {
    e.preventDefault();
    akunIndex = (akunIndex - 1 + items.length) % items.length;
    highlight(items, akunIndex);
  }
  if (e.key === "Enter") {
    e.preventDefault();
    if (akunIndex >= 0 && items[akunIndex]) items[akunIndex].click();
  }
});

function highlight(items, idx) {
  items.forEach(it => it.classList.remove("active-highlight"));
  if (items[idx]) items[idx].classList.add("active-highlight");
}


// ------------------ HITUNG MDR GO-PAY ------------------
function hitungMDR(total) {
  if (total <= 500000) return 0;
  return Math.round(total * 0.003); // MDR 0.3%
}

function refreshHitung() {
  const nominal = toAngka(document.getElementById("nominal").value);
  const mdr = hitungMDR(nominal);
  const net = nominal - mdr;

  document.getElementById("mdr").value = mdr.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  document.getElementById("net").value = net.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

document.getElementById("nominal").addEventListener("input", refreshHitung);
document.getElementById("metode").addEventListener("change", refreshHitung);


// ------------------ ENTER → NEXT INPUT ------------------
document.getElementById("form").addEventListener("keydown", function (e) {
  if (e.key === "Enter" && !e.ctrlKey && e.target.type !== "submit") {
    e.preventDefault();
    const idx = Array.prototype.indexOf.call(this, e.target);
    if (this.elements[idx + 1]) this.elements[idx + 1].focus();
  }
});

// ------------------ CTRL+ENTER → SUBMIT ------------------
document.addEventListener("keydown", e => {
  if (e.ctrlKey && e.key === "Enter") {
    e.preventDefault();
    document.getElementById("btn").click();
  }
});


// ------------------ SUBMIT ------------------
document.getElementById("form").addEventListener("submit", async e => {
  e.preventDefault();

  const btn = document.getElementById("btn");
  btn.disabled = true;
  btn.innerHTML = "Menyimpan...";

  try {
    const tanggal = document.getElementById("tanggal").value || new Date().toISOString().slice(0, 10);
    const id_kasbank = document.getElementById("id_kasbank").value;
    const metode = document.getElementById("metode").value;

    const nominal = toAngka(document.getElementById("nominal").value);
    const mdr = hitungMDR(nominal);
    const net = nominal - mdr;

    const kode_akun_lawan = inpAkun.dataset.kode;
    if (!kode_akun_lawan) throw new Error("Pilih akun lawan (ketik lalu pilih).");

    const referensi = document.getElementById("referensi").value.trim() || null;
    const keterangan = document.getElementById("keterangan").value.trim() || null;

    // Insert penerimaan
    const { data:pen, error:errPen } = await db.from("tb_penerimaan").insert([{
      tanggal, id_kasbank, metode, nominal, mdr, net, kode_akun_lawan, referensi, keterangan
    }]).select().single();

    if (errPen) throw errPen;
    const idP = pen.id_penerimaan;

    // ambil kode akun kas/bank dari tb_kasbank
    const opt = document.querySelector(`#id_kasbank option[value="${id_kasbank}"]`);
    const kodeAkunKas = opt.dataset.akun;

    // Insert jurnal debit KAS/BANK
    await db.from("tb_jurnal").insert([{
      tanggal, id_source:idP, sumber:"penerimaan",
      kode_akun:kodeAkunKas, debit:net, kredit:0,
      keterangan:keterangan || "Penerimaan"
    }]);

    // Insert jurnal biaya MDR jika ada
    if (mdr > 0) {
      await db.from("tb_jurnal").insert([{
        tanggal, id_source:idP, sumber:"penerimaan",
        kode_akun:"610010", debit:mdr, kredit:0,
        keterangan:"Biaya QRIS GoPay"
      }]);
    }

    // Insert jurnal kredit akun lawan
    await db.from("tb_jurnal").insert([{
      tanggal, id_source:idP, sumber:"penerimaan",
      kode_akun:kode_akun_lawan, debit:0, kredit:nominal,
      keterangan:keterangan || "Penerimaan"
    }]);

    alert("Penerimaan berhasil disimpan.");
    location.href = "h_penerimaan_tab.html";

  } catch (err) {
    alert("Gagal: " + err.message);
    btn.disabled = false;
    btn.innerHTML = "Simpan";
  }
});
</script>
</body>
</html>
