<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Tambah Pembelian</title>
    <link rel="icon" href="img/logo.svg">
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/noscroll.css">
    <link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/id.js"></script>

    <style>
.dropdown-menu.show {
    display:block;
    max-height:200px;
    overflow-y:auto;
    cursor:pointer;
}
.input-error {
    border: 1px solid #dc3545 !important; /* merah bootstrap */
    box-shadow: 0 0 4px rgba(220,53,69,0.4) !important;
}
#dropdown_kategori.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
#dropdown_merek.dropdown-menu {
    width: 100% !important;
    min-width: 100% !important;
    left: 0 !important;
    right: 0 !important;
}
table {
  overflow: visible !important;
}

table tbody,
table tr,
table td {
  overflow: visible !important;
}

.dd-produk {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 9999 !important;
}
/* === FIX dropdown produk terpotong === */
.table-responsive {
  overflow: visible !important;
}

.table-responsive table,
.table-responsive tbody,
.table-responsive tr,
.table-responsive td {
  overflow: visible !important;
}

.dd-produk {
    min-width: 350px !important;  /* atur sesuai kebutuhan */
    white-space: normal !important; /* biar teks turun ke bawah, bukan terpotong */
}
#tbl input.form-control-sm,
#tbl select.form-control-sm {
    border-radius: 7px !important;   /* ubah sesuai selera: 4px, 8px, 12px */
}
.dropdown-item.active-highlight {
    background-color: #e3e6f0  !important;
    color: black !important;
}
.shortcut-menu {
    gap: 10px;
    margin-top: 45px !important; /* turun dari 70 px ‚Üí lebih dekat ke navbar */
}

.shortcut-item {
    width: 55px; /* dari 70px */
    text-align: center;
    text-decoration: none !important;
}

.shortcut-icon {
    width: 38px;   /* dari 50px */
    height: 38px;  /* dari 50px */
    border-radius: 10px; /* sedikit lebih kecil */
    font-size: 16px;     /* dari 20px */
    display: flex;
    justify-content: center;
    align-items: center;
    margin: auto;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
}

.shortcut-text {
    margin-top: 4px;
    font-size: 11px; /* dari 12px */
    color: #444;
}
.form-horizontal .form-group {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.form-horizontal label {
    width: 110px; /* lebar label (bisa diubah) */
    margin-bottom: 0;
    font-size: 13px;
    color: #333;
}

.form-horizontal .form-control,
.form-horizontal .form-select {
    flex: 1;
}
/* Agar wrapper kategori/merek ikut aturan flex dan ukurannya sama dgn input lainnya */
.form-horizontal .form-group > .position-relative {
    flex: 1;                       /* wajib */
    display: flex;                 /* biar textarea/input di dalamnya ikut full */
    align-items: center;
}

.form-horizontal .position-relative input.form-control-sm {
    width: 100%;                   /* pastikan penuh */
}
.gap-2 > * {
    margin-left: 6px;
}
.card-body {
    padding-bottom: 10px !important;
}

#pagination {
    margin: 0 !important;
    padding: 0 !important;
}
.inp-nama {
    white-space: normal !important;   /* izinkan teks panjang */
    overflow: visible !important;
    text-overflow: unset !important;
}
#col-tempo,
#col-jatuh-tempo {
    display: none;
}
#tbl input.form-control-sm,
#tbl select.form-control-sm {
  border: none;
  background: transparent;
  box-shadow: none;
  padding: 2px 4px;
}

#tbl input.form-control-sm:focus,
#tbl select.form-control-sm:focus {
  outline: none;
  font-weight: 800;
}
#tbl td {
  vertical-align: middle;
}

#tbl .subtotal-cell {
  font-weight: 600;
}
/* ================================
   SUPER COMPACT TABLE (EXCEL STYLE)
   ================================ */
/* Cell tabel super rapat */
#tbl th,
#tbl td {
  padding: 1px 3px !important;
  vertical-align: middle;
  font-size: 12px;
}

/* Header sedikit lebih tebal */
#tbl thead th {
  padding: 4px 3px !important;
  font-weight: 600;
}

/* Input & select di tabel */
#tbl input.form-control-sm,
#tbl select.form-control-sm {
  padding: 0 3px;          /* üî• kunci utama */
  height: 22px;            /* mirip Excel */
  line-height: 1.1;
  font-size: 14px;
  border: none;
  background: transparent;
  box-shadow: none;
}

/* Hilangkan panah number (lebih Excel-like) */
#tbl input[type=number]::-webkit-inner-spin-button,
#tbl input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Fokus = underline + bold */
#tbl input.form-control-sm:focus,
#tbl select.form-control-sm:focus {
  outline: none;
  font-weight: 700;
  border-bottom: 1px solid #4e73df;
}

/* Baris aktif (saat ada input fokus) */
#tbl tr.line-row:focus-within {
  background-color: #f8f9fc;
}

/* Hover ringan */
#tbl tbody tr:hover {
  background-color: #f1f3f8;
}

/* Subtotal lebih menonjol */
#tbl .subtotal-cell {
  font-weight: 700;
  font-size: 14px;
}

/* Aksi (icon hapus) kecil & rapi */
#tbl .action-icon {
  cursor: pointer;
}
/* ===============================
   HOVER ICON HAPUS BARIS
   =============================== */
/* Hover icon hapus (SVG) */
#tbl .btn-delete svg {
  fill: #6c757d;                 /* warna normal */
  transition: fill 0.15s ease, transform 0.1s ease;
}

#tbl .btn-delete:hover svg {
  fill: #e74a3b;                 /* merah */
  transform: scale(1.15);
}
/* ================================
   ORDER MODAL ‚Äì EXCEL STYLE
================================ */
#tbl-order th,
#tbl-order td {
  padding: 1px 3px !important;
  vertical-align: middle;
  font-size: 14px;
}

#tbl-order thead th {
  padding: 4px 3px !important;
  font-weight: 600;
}

#tbl-order input.form-control-sm,
#tbl-order select.form-control-sm {
  padding: 0 3px;
  height: 22px;
  line-height: 1.1;
  font-size: 14px;
  border: none;
  background: transparent;
  box-shadow: none;
}

#tbl-order tr.line-row:focus-within {
  background-color: #f8f9fc;
}

#tbl-order .btn-delete svg {
  fill: #6c757d;
}

#tbl-order .btn-delete:hover svg {
  fill: #e74a3b;
  transform: scale(1.15);
}
#tbl-order thead th {
  background: linear-gradient(to bottom, #f5f5f5, #ededee);
  color: #7789bf;
  font-weight: 600;
  border-bottom: 2px solid #ffffff;
}
/* ORDER SUDAH DIPAKAI */
.order-used {
  background-color: #f1f3f8 !important;
  color: #9aa0ac !important;
}

.order-used td {
  /*text-decoration: line-through;*/
}

.order-used input[type="checkbox"] {
  pointer-events: none;
}

</style>
</head>
<body id="page-top">
<div id="navbar"></div>
    <div id="wrapper">
<!-- CONTENT -->
  <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
<div class="container-fluid">    
  <div id="shortcut"></div>
  <div class="card shadow mb-4"> 
    <div class="card-header d-flex justify-content-between align-items-center py-2">
      <!-- JUDUL -->
      <h6 class="m-0 font-weight-bold text-primary">Pembelian</h6>
        <div class="d-flex gap-2 align-items-center">
              <button type="button"
          id="btnOrderan"
          class="btn btn-outline-dark btn-sm"
          title="Pilih Orderan Supplier"
          disabled>
    üì¶ Orderan
  </button>
            <button type="button" id="btnSave" class="btn btn-primary btn-sm">Simpan</button>
            <a href="h_pembelian_tab.html" class="btn btn-secondary btn-sm">Daftar Pembelian</a>
        </div>
    </div>
    <div class="card-body">
          <form id="form">
            <div class="form-row">
              <div>
                <!-- <small>Kode</small> -->
                <input type="hidden" id="kode">
              </div>
              <div class="col-md-2 mb-2">
                <!-- <small>Tanggal</small> -->
                <input type="text" id="tanggal" class="form-control form-control-sm" data-toggle="tooltip" data-placement="top" placeholder="DD/MM/YYYY" autocomplete="off">
              </div>
                            <div class="col-md-3 mb-2">
                <!-- <small>Supplier</small> -->
                <input id="cari_mitra" class="form-control form-control-sm" placeholder="CASH" data-toggle="tooltip" data-placement="top" title="Supplier">
                <div id="dd_mitra" class="dropdown-menu w-100"></div>
              </div>
              <div class="col-md-2 mb-2">
                <!-- <small>Termin</small> -->
                <select id="termin" class="form-control form-control-sm" data-toggle="tooltip" data-placement="top" title="Termin Pembelian">
                    <option value="cash">CASH</option>
                    <option value="credit">CREDIT</option>
                </select>
              </div>

            <div class="col-md-1 mb-2" id="col-tempo">
              <!-- <small id="lbl-tempo">Tempo (hari)</small> -->
              <input id="tempo" type="number" min="0" class="form-control form-control-sm" value="0" data-toggle="tooltip" data-placement="top" title="Durasi Tempo">
            </div>

            <div class="col-md-2 mb-2" id="col-jatuh-tempo">
              <!-- <small>Tanggal Jatuh Tempo</small> -->
              <input type="text" id="jatuh_tempo" class="form-control form-control-sm" data-toggle="tooltip" data-placement="top" title="Tanggal Jatuh Tempo" placeholder="DD/MM/YYYY" readonly>
            </div>

            <div class="col-md-2 mb-2" id="wrap_pembayaran">
              <!-- <small>Pembayaran</small> -->
              <select id="pembayaran" class="form-control form-control-sm" data-toggle="tooltip" data-placement="top" title="Metode Pembayara">
                <option value="">Kas Utama</option>
              </select>
            </div>


              <input id="keterangan" class="form-control form-control-sm" type="hidden" >
            </div>
            <div class="table-responsive mt-2">
              <table class="table table-sm table-bordered" id="tbl">
                <thead class="table-secondary">
                    <tr>
                        <th width="30px">No.</th>
                        <th>Item</th>
                        <th width="70px">Qty</th>
                        <th width="100px">Satuan</th>
                        <th width="100px">Harga</th>
                        <th width="100px">Diskon</th>
                        <th width="110px">Pajak</th>
                        <th width="220px">Subtotal</th>
                        <th width="30px"></th>
                    </tr>
                </thead>
                <tbody class="table-bordered"></tbody>
              </table>
            </div>
            <div class="row mt-2">
              <div class="col-md-6"></div>
              <div class="col-md-6">
            <table class="table table-borderless table-sm">
              <tbody>

                <tr>
                  <td class="text-right small" style="width:300px">Sub Total</td>
                  <td class="text-right" id="subTxt">0</td>
                </tr>

                <tr>
                  <td class="text-right small" style="width:300px">Diskon Total (Rp)</td>
                  <td>
                    <input
                      id="diskon_total"
                      class="form-control form-control-sm text-right"
                      value="0">
                  </td>
                </tr>

                <tr>
                  <td class="text-right small" style="width:300px">Biaya Lain (Rp)</td>
                  <td>
                    <input
                      id="biaya_lain"
                      class="form-control form-control-sm text-right"
                      value="0">
                  </td>
                </tr>

                <!-- üîΩ BARIS DP (DI-HIDE / SHOW DARI JS) -->
                <tr id="row_dp">
                  <td class="text-right small" style="width:300px">DP / Titip Uang (Rp)</td>
                  <td>
                    <input
                      id="dp"
                      class="form-control form-control-sm text-right"
                      value="0">
                  </td>
                </tr>

                <tr>
                  <td class="text-right font-weight-bold">Grand Total</td>
                  <td class="text-right font-weight-bold" id="grandTxt">0</td>
                </tr>

              </tbody>
            </table>

              </div>
            </div>
          </form>
      </div>
    </div>
    <div class="modal fade" id="modalTambahMerek" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title">Tambah Merek Baru</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <div class="modal-body">
        <label>Kode</label>
        <input type="text" id="kode_merek_baru" class="form-control mb-3" placeholder="AUTO">

        <label>Nama Merek</label>
        <input type="text" id="nama_merek_baru" class="form-control">
      </div>

      <div class="modal-footer">
        <button id="btnSimpanMerekBaru" class="btn btn-primary" onclick="simpanMerekBaru()">Simpan</button>
        <button class="btn btn-secondary" data-dismiss="modal">Batal</button>
      </div>

    </div>
  </div>


</div>
  <div class="modal fade" id="modalTambahKategori" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title">Tambah Kategori Baru</h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <div class="modal-body">
        <label>Kode</label>
        <input type="text" id="kode_kategori_baru" class="form-control mb-3" placeholder="AUTO">

        <label>Nama Kategori</label>
        <input type="text" id="nama_kategori_baru" class="form-control">
      </div>

      <div class="modal-footer">
        <button id="btnSimpanKategoriBaru" class="btn btn-primary" onclick="simpanKategoriBaru()">Simpan</button>
        <button class="btn btn-secondary" data-dismiss="modal">Batal</button>
      </div>

    </div>
  </div>
</div>

</div>
<div class="modal fade" id="modalOrderPicker" tabindex="-1" data-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title">Orderan Aktif</h6>
        <div class="ml-auto d-flex gap-2">
          <button class="btn btn-light btn-sm" onclick="applySelectedOrders()">üíæ Save</button>
          <button class="btn btn-light btn-sm" data-dismiss="modal">‚ùå Close</button>
        </div>
      </div>
      <div class="modal-body p-2">
        <table class="table table-sm table-bordered table-tight" id="tbl-order">
          <thead>
            <tr>
              <th width="30"></th>
              <th>Produk</th>
              <th width="60">Qty</th>
              <th width="70">Satuan</th>
            </tr>
          </thead>
          <tbody id="tbOrderPicker"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>
<script src="js/navbar_on_off.js"></script>
<script>
function initNavbarQuickSearch() {
  const nav = document.getElementById("navbar");
  if (!nav) return;
  const input = nav.querySelector("#quickSearchInput");
  if (!input || input.dataset.bound) return;
  input.dataset.bound = "1";
  input.addEventListener("keydown", e => {
    if (e.key !== "Enter") return;
    e.preventDefault();
    const q = input.value.trim();
    if (!q) return;
    location.href =
      "h_harga_produk.html?q=" + encodeURIComponent(q);
  });
}
async function loadNavbar() {
  const navEl = document.getElementById("navbar");
  if (localStorage.getItem("navbar")) {
    navEl.innerHTML = localStorage.getItem("navbar");
    navEl.classList.add("loaded");
  }
  const res = await fetch("navbar.html");
  const html = await res.text();
  localStorage.setItem("navbar", html);
  navEl.innerHTML = html;
  navEl.classList.add("loaded");
  if (typeof applyShortcutVisibility === "function") {
    applyShortcutVisibility();
  }
  initNavbarQuickSearch();
}
async function loadShortcut() {
  if (!isShortcutEnabled()) {
    const el = document.getElementById("shortcut");
    if (el) el.style.display = "none";
    return;
  }

  const el = document.getElementById("shortcut");

  if (localStorage.getItem("shortcut_html")) {
    el.innerHTML = localStorage.getItem("shortcut_html");
    applyShortcutIcons(); // ‚¨ÖÔ∏è WAJIB
  }

  const res = await fetch("shortcut.html");
  const html = await res.text();

  localStorage.setItem("shortcut_html", html);
  el.innerHTML = html;

  applyShortcutIcons(); // ‚¨ÖÔ∏è WAJIB
}
loadNavbar();
loadShortcut();
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/db_supabase.js"></script>
<script>
// ===================== HELPERS =====================
function fmt(n){ return (n==null||n===0) ? '0' : n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }
function toNum(s){ return parseFloat((s||'').toString().replace(/\./g,'')) || 0; }

function formatRupiahInput(el) {
    el.addEventListener("input", () => {
        let val = el.value.replace(/\D/g, ""); // hanya angka
        if (val === "") {
            el.value = "";
            return;
        }
        el.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    });
}

function intOnlyInput(el){
  if(!el) return;
  el.addEventListener('input', ()=> {
    el.value = el.value.replace(/\D/g,'');
  });
}

function soundError() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = "sawtooth";
    osc.frequency.value = 200;

    gain.gain.setValueAtTime(0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);

    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start();
    osc.stop(ctx.currentTime + 0.25);
}

function parseDiskon(raw, qty, harga){
  if(!raw) return 0;

  raw = raw.toString().trim();
  const parts = raw.split('+').map(p => p.trim()).filter(Boolean);

  let hargaAkhir = harga;

  for(const p of parts){
    if(p.endsWith('%')){
      // DISKON PERSEN BERTINGKAT
      const pct = parseFloat(p.replace('%','')) || 0;
      const pot = Math.floor(hargaAkhir * pct / 100);
      hargaAkhir -= pot;
    } else {
      // DISKON NOMINAL (PER UNIT)
      const val = parseInt(p.replace(/\./g,'').replace(/,/g,'')) || 0;
      hargaAkhir -= val;
    }

    // safety: jangan minus
    if(hargaAkhir < 0) hargaAkhir = 0;
  }

  // total diskon = (harga awal - harga akhir) √ó qty
  return (harga - hargaAkhir) * qty;
}


function cleanDiskonInput(el){
    el.addEventListener("input", () => {
        el.value = el.value
            .replace(/[^0-9+.%]/g, "")  // hanya angka, +, ., %
            .replace(/(\++)+/g, "+")    // hilangkan ++ menjadi +
            .replace(/(\.)+/g, ".");    // hilangkan .. menjadi .
    });
}

function hitungHppSatuan1({
  hargaInput,      // harga yang diketik user
  satuanInput,     // satuan yang dipilih user
  satuan1,
  satuan2,
  satuan3,
  konversi2 = 1,
  konversi3 = 1
}) {
  if (!hargaInput || !satuanInput) return 0;

  // BELI DALAM SATUAN DASAR
  if (satuanInput === satuan1) {
    return hargaInput;
  }

  // BELI DALAM SATUAN 2 (misal LUSIN)
  if (satuanInput === satuan2) {
    return hargaInput / konversi2;
  }

  // BELI DALAM SATUAN 3 (misal KODI)
  if (satuanInput === satuan3) {
    return hargaInput / (konversi2 * konversi3);
  }

  // fallback aman
  return hargaInput;
}

function ddmmyyyyToISO(v) {
  if (!v) return null;
  const [d, m, y] = v.split("/");
  return `${y}-${m}-${d}`;
}

function isoToDDMMYYYY(iso) {
  if (!iso) return "";
  const [y, m, d] = iso.split("-");
  return `${d}/${m}/${y}`;
}

// ===================== ELEMENTS =====================
const kode = document.getElementById('kode');
const tanggal = document.getElementById('tanggal');
const cari_mitra = document.getElementById('cari_mitra');
const dd_mitra = document.getElementById('dd_mitra');
const termin = document.getElementById('termin');
const tempo = document.getElementById('tempo');
const jatuh_tempo = document.getElementById("jatuh_tempo");
const keterangan = document.getElementById('keterangan');
const tblBody = document.querySelector('#tbl tbody');
const subTxt = document.getElementById('subTxt');
const diskon_total = document.getElementById('diskon_total');
const biaya_lain = document.getElementById('biaya_lain');
const grandTxt = document.getElementById('grandTxt');
const btnSave = document.getElementById('btnSave');
let isSettingDefaultSupplier = false;
const wrapPembayaran = document.getElementById("wrap_pembayaran");
const pembayaran = document.getElementById("pembayaran");
const DEFAULT_KASBANK_KODE = "KS01"; // Kas Utama
let AKUN_PERSEDIAAN = null;
let kasbankMap = {}; // id_kasbank -> kode_akun
let kasbankLoaded = false;
const wrapDp = document.getElementById("row_dp");
const dp = document.getElementById("dp");
const btnOrderan = document.getElementById("btnOrderan");
let cachedOrders = []; // cache order supplier aktif
intOnlyInput(dp);
formatRupiahInput(dp);


async function preloadSettingAkun() {
  const { data, error } = await db
    .from("tb_setting_akun")
    .select("kode_akun")
    .eq("key", "inventory")
    .single();

  if (error || !data) {
    console.warn("Setting akun inventory belum ada");
    return;
  }

  AKUN_PERSEDIAAN = data.kode_akun;
}


termin.value = "cash";
tempo.value = 0;
tempo.setAttribute("disabled", "disabled");
jatuh_tempo.value = "";

intOnlyInput(diskon_total);
intOnlyInput(biaya_lain);
// tanggal.value = new Date().toISOString().slice(0,10);

const colTempo = document.getElementById("col-tempo");
const colJatuhTempo = document.getElementById("col-jatuh-tempo");

function updateTerminUI() {
  const isCash = termin.value === "cash";
  const dpVal = toNum(dp.value);

  if (isCash) {
    // ================= CASH =================
    colTempo.style.display = "none";
    colJatuhTempo.style.display = "none";
    tempo.value = 0;
    jatuh_tempo.value = "";

    // üîí DP tidak relevan di CASH
    wrapDp.style.display = "none";
    dp.value = 0;

    // pembayaran WAJIB
    wrapPembayaran.style.display = "block";
    loadKasBank();

  } else {
    // ================= CREDIT =================
    colTempo.style.display = "block";
    colJatuhTempo.style.display = "block";

    // DP boleh muncul
    wrapDp.style.display = "";

    // pembayaran hanya muncul jika DP > 0
    if (dpVal > 0) {
      wrapPembayaran.style.display = "block";
      loadKasBank();
    } else {
      wrapPembayaran.style.display = "none";
      pembayaran.value = "";
    }
  }

  updateJatuhTempo();
}



dp.addEventListener("input", () => {
  updateTerminUI();
});


async function loadKasBank() {
      if (kasbankLoaded) return;
      kasbankLoaded = true;
      const { data, error } = await db
        .from("tb_kasbank")
        .select("id_kasbank, kode, nama_rekening, tipe, kode_akun")
        .eq("aktif", true)
        .order("tipe")
        .order("nama_rekening");

      if (error) {
        console.error("Gagal load kasbank", error);
        return;
      }

      pembayaran.innerHTML = `<option value="">Pilih</option>`;
      kasbankMap = {};

      data.forEach(d => {
        // üî• CACHE DI SINI
        kasbankMap[d.id_kasbank] = d.kode_akun;

        pembayaran.innerHTML += `
          <option value="${d.id_kasbank}">
            ${d.nama_rekening}
          </option>
        `;
      });

      // auto pilih Kas Utama
      const def = data.find(d => d.kode === DEFAULT_KASBANK_KODE);
      if (def) pembayaran.value = def.id_kasbank;
}


function updateJatuhTempo() {
  const tglText = tanggal.value;
  const isCredit = termin.value === "credit";
  const tempoHari = parseInt(tempo.value) || 0;

  if (!tglText || !isCredit || tempoHari <= 0) {
    fpJatuhTempo.clear();
    return;
  }

  const iso = ddmmyyyyToISO(tglText);
  const d = new Date(iso);
  d.setDate(d.getDate() + tempoHari);

  fpJatuhTempo.setDate(d, true);
}

tanggal.addEventListener("change", updateJatuhTempo);
tempo.addEventListener("input", updateJatuhTempo);
tempo.addEventListener("keydown", function(e){
    if (e.key === "Enter") {
        e.preventDefault();

        // Fokus ke input produk baris pertama
        const firstProduk = tblBody.querySelector("tr.line-row:first-child .inp-nama");
        if (firstProduk) {
            firstProduk.focus();
            firstProduk.select();
        }
    }
});

// ===================== KODE =====================
async function genKode(){
  const { data } = await db.from('tb_pembelian')
    .select('kode_pembelian')
    .order('created_at',{ascending:false})
    .limit(1);

  let next = 1;
  if(data && data.length){
    next = (parseInt(data[0].kode_pembelian.replace(/\D/g,'')) || 0) + 1;
  }
  kode.value = "BL" + String(next).padStart(7,'0');
}
genKode();

let mitraItems = [];
let mitraIndex = -1;
cari_mitra.addEventListener("keydown", function(e){
    // Jika dropdown tidak tampil ‚Üí abaikan navigasi
    if (!dd_mitra.classList.contains("show")) return;

    if (e.key === "ArrowDown") {
        e.preventDefault();
        if (mitraItems.length === 0) return;
        mitraIndex = (mitraIndex + 1) % mitraItems.length;
    }

    if (e.key === "ArrowUp") {
        e.preventDefault();
        if (mitraItems.length === 0) return;
        mitraIndex = (mitraIndex - 1 + mitraItems.length) % mitraItems.length;
    }

    // ENTER pilih supplier
    if (e.key === "Enter") {
        e.preventDefault();
        if (mitraIndex >= 0 && mitraItems[mitraIndex]) {
            mitraItems[mitraIndex].click();
        }
    }

    updateMitraHighlight();
});
function updateMitraHighlight() {
    mitraItems.forEach(el => el.classList.remove("active-highlight"));
    if (mitraIndex >= 0 && mitraItems[mitraIndex]) {
        mitraItems[mitraIndex].classList.add("active-highlight");
        mitraItems[mitraIndex].scrollIntoView({ block: "nearest" });
    }
}
function getUsedOrderItemIds() {
  return new Set(
    Array.from(tblBody.querySelectorAll("tr.line-row"))
      .map(r => r.dataset.order_item_id)
      .filter(Boolean)
  );
}
function updateSaveOrderButton() {
  const btnSaveOrder = document.querySelector(
    "#modalOrderPicker button[onclick='applySelectedOrders()']"
  );
  if (!btnSaveOrder) return;

  // checkbox yang MASIH bisa dipilih
  const available = document.querySelectorAll(
    "#tbOrderPicker .pick-order:not(:disabled)"
  );

  btnSaveOrder.disabled = available.length === 0;
  btnSaveOrder.title = btnSaveOrder.disabled
    ? "Semua item order sudah di-import"
    : "Import item order terpilih";
}

// ===================== MITRA SEARCH =====================
let timerM = null;

cari_mitra.addEventListener('input', function (e) {

  // üîí Abaikan input dari sistem (default / set otomatis)
  if (isSettingDefaultSupplier) return;

  // üîí Abaikan input non-user (safety tambahan)
  if (!e.isTrusted) return;

  // ‚ùó reset ID HANYA kalau user benar-benar mengetik
  this.dataset.id = "";
    // üî• RESET ORDER STATE
  cachedOrders = [];
  document.getElementById("btnOrderan").disabled = true;

  if (this.value.trim() === "") {
    termin.value = "cash";
    tempo.value = 0;
    tempo.setAttribute("disabled","disabled");
    jatuh_tempo.value = "";
  }

  clearTimeout(timerM);

  const kw = this.value.trim();
  if (kw.length < 3) {
    dd_mitra.classList.remove('show');
    dd_mitra.innerHTML = "";
    return;
  }

  dd_mitra.classList.add('show');

  timerM = setTimeout(async () => {
    const { data } = await db
      .from('tb_mitra')
      .select('id_mitra,nama_mitra,termin_pembelian,tempo_pembelian,akun_hutang')
      .ilike('nama_mitra', `%${kw}%`)
      .limit(15);

    if (!data || !data.length) {
      dd_mitra.innerHTML = `<div class="dropdown-item text-muted">Tidak ada</div>`;
      return;
    }

    dd_mitra.innerHTML = data.map(m => `
      <div class="dropdown-item"
        data-id="${m.id_mitra}"
        data-nama="${m.nama_mitra}"
        data-termin="${m.termin_pembelian || 'cash'}"
        data-tempo="${m.tempo_pembelian || 0}"
        data-akun="${m.akun_hutang || ''}">
        ${m.nama_mitra}
      </div>
    `).join("");

    dd_mitra.classList.add("show");
    mitraItems = Array.from(dd_mitra.querySelectorAll(".dropdown-item"));
    mitraIndex = -1;

  }, 200);
});

// --- ketika pilih supplier dari dropdown ---
dd_mitra.addEventListener('click', e => {
  const it = e.target.closest('.dropdown-item');
  if(!it) return;

  // simpan informasi supplier di input cari_mitra
  cari_mitra.value = it.dataset.nama;
  cari_mitra.dataset.id = it.dataset.id;
  // simpan tempo asli supplier (string) agar bisa dipakai kembali
  cari_mitra.dataset.tempo = it.dataset.tempo || "0";
  cari_mitra.dataset.termin = it.dataset.termin || "cash";
  cari_mitra.dataset.akun_hutang = it.dataset.akun || "";

  // set termin & tempo berdasarkan data supplier
  termin.value = cari_mitra.dataset.termin;
  termin.dispatchEvent(new Event("change"));

  if (termin.value === 'cash') {
    // kalau cash -> tempo disabled dan kosong (atau 0 sesuai preferensi)
    tempo.value = 0;
    tempo.setAttribute('disabled','disabled');

    // fokus ke input produk langsung
    setTimeout(()=>{
      const firstProduk = tblBody.querySelector('tr.line-row:first-child .inp-nama');
      if(firstProduk){ firstProduk.focus(); firstProduk.select(); }
    }, 10);
  } else {
    // credit -> aktifkan tempo dan isi dengan tempo supplier yang sudah disimpan
    tempo.removeAttribute('disabled');
    // pastikan parseInt aman dan fallback jika kosong
    const supplierTempo = parseInt(cari_mitra.dataset.tempo || "0") || 0;
    tempo.value = supplierTempo;

    // fokus ke tempo supaya user bisa ubah kalau perlu
    setTimeout(()=> {
      tempo.focus();
      tempo.select && tempo.select();
    }, 10);
  }

async function afterSupplierSelected(idMitra) {
  cachedOrders = await loadOrderBySupplier(idMitra);

  if (cachedOrders.length > 0) {
    btnOrderan.disabled = false;
    btnOrderan.title = "Lihat orderan supplier";

    // üî• AUTO POPUP SEKALI
    renderOrderPicker(cachedOrders);
    $('#modalOrderPicker').modal('show');
  } else {
    btnOrderan.disabled = true;
    btnOrderan.title = "Supplier tidak memiliki order aktif";
  }
}


  dd_mitra.classList.remove('show');
  afterSupplierSelected(cari_mitra.dataset.id);
  updateJatuhTempo();
});

// async function loadOrderBySupplier(idMitra) {
//   const { data } = await db
//     .from("tb_order_item")
//     .select(`
//       id_item,
//       qty,
//       qty_sisa,
//       satuan,
//       nama_manual,
//       tb_order!inner(id_order, status),
//       tb_produk(nama_produk)
//     `)
//     .eq("tb_order.id_mitra", idMitra)
//     .neq("tb_order.status", "done");

//   return data || [];
// }
async function loadOrderBySupplier(idMitra) {
  const { data, error } = await db
    .from("tb_order_item")
    .select(`
      id_item,
      qty,
      qty_sisa,
      satuan,
      nama_manual,
      tb_order!inner(id_order, status),
      tb_produk(nama_produk)
    `)
    .eq("tb_order.id_mitra", idMitra)
    .neq("tb_order.status", "done")
    .gt("qty_sisa", 0); // üî• INI KUNCINYA

  if (error) {
    console.error("Gagal load order supplier", error);
    return [];
  }

  return data || [];
}

function renderOrderPicker(items) {
  const tb = document.getElementById("tbOrderPicker");
  const usedIds = getUsedOrderItemIds();

  const filtered = items.filter(i => {
    const sisa = i.qty_sisa ?? i.qty;
    return Number(sisa) > 0;
  });

  if (filtered.length === 0) {
    tb.innerHTML = `
      <tr>
        <td colspan="4" class="text-center text-muted">
          Tidak ada item order yang tersisa
        </td>
      </tr>
    `;
    return;
  }

  tb.innerHTML = filtered.map(i => {
    const isUsed = usedIds.has(String(i.id_item));

    return `
      <tr class="${isUsed ? 'order-used' : ''}"
          data-id="${i.id_item}"
          data-order="${i.tb_order.id_order}"
          ${isUsed ? 'title="Item order sudah di-import"' : ''}>
        <td class="text-center">
          <input type="checkbox"
                 class="pick-order"
                 ${isUsed ? 'disabled checked' : ''}>
        </td>
        <td>${i.tb_produk?.nama_produk || i.nama_manual}</td>
        <td class="text-right">${i.qty_sisa}</td>
        <td>${i.satuan}</td>
      </tr>
    `;
  }).join("");

  // üî• AUTO SCROLL ke item pertama yang masih bisa dipilih
  setTimeout(() => {
    const firstActive = document.querySelector(
      "#tbOrderPicker tr:not(.order-used)"
    );
    firstActive?.scrollIntoView({ block: "nearest" });
  }, 50);
  updateSaveOrderButton();
}


function applySelectedOrders() {
  const available = document.querySelectorAll("#tbOrderPicker .pick-order:not(:disabled)");
  if (available.length === 0) return;
  const rows = document.querySelectorAll("#tbOrderPicker tr");

  rows.forEach(r => {
    const chk = r.querySelector(".pick-order");
    if (!chk || chk.disabled || !chk.checked) return;

    const nama   = r.children[1].innerText.trim();
    const qtySisa = Number(r.children[2].innerText);
    const satuan = r.children[3].innerText.trim();

    // üîç cari baris kosong pertama
    let tr = Array.from(tblBody.querySelectorAll("tr.line-row"))
      .find(row => !row.querySelector(".inp-nama").value.trim());

    // kalau tidak ada ‚Üí buat baru
    if (!tr) {
      tr = createRow();
      tblBody.appendChild(tr);
    }

    // isi data
    tr.dataset.order_item_id = r.dataset.id;
    tr.dataset.order_id = r.dataset.order;
    tr.dataset.qty_sisa = qtySisa;


    tr.querySelector(".inp-nama").value = nama;
    tr.querySelector(".inp-qty").value = qtySisa;

    // üî• ISI SATUAN (lihat bug 2)
    const selSatuan = tr.querySelector(".inp-satuan");
    selSatuan.innerHTML = `<option value="${satuan}">${satuan}</option>`;
    selSatuan.value = satuan;
  });

  refreshRowNumbers();
  refreshTotals();
  $('#modalOrderPicker').modal('hide');
}

// ===================== DYNAMIC ROWS =====================
const TAX_RATES = { NO:0, PPN:0.10 };

function createRow(){
  const tr = document.createElement('tr');
  tr.className = 'line-row';

  tr.innerHTML = `
    <td class="line-no text-center"></td>

    <td>
      <div style="position:relative">
        <input type="text"
               class="form-control form-control-sm inp-nama"
               title="Cari Produk">
        <div class="dropdown-menu dd-produk w-100"></div>
      </div>
    </td>

    <td>
      <input class="form-control form-control-sm inp-qty text-right" value="1">
    </td>

    <td>
      <select class="form-control form-control-sm inp-satuan">
        <option value="">Satuan</option>
      </select>
    </td>

    <td>
      <input class="form-control form-control-sm inp-harga text-right" value="0">
    </td>

    <td>
      <input class="form-control form-control-sm inp-diskon text-right">
    </td>

    <td>
      <select class="form-control form-control-sm inp-pajak">
        <option value="NO">No Pajak</option>
        <option value="PPN">PPN</option>
      </select>
    </td>

    <td class="subtotal-cell text-right">0</td>

    <td class="text-center">
      <span class="action-icon text-dark btn-delete"
            title="Hapus baris">
        ${ICON_SILANG}
      </span>
    </td>
  `;

  attachRowHandlers(tr);
  return tr;
}

function moveRowFocus(currentInput, direction) {
    const row = currentInput.closest("tr.line-row");
    if (!row) return;

    const allRows = Array.from(tblBody.querySelectorAll("tr.line-row"));
    const index = allRows.indexOf(row);
    const newIndex = index + direction;

    if (newIndex < 0 || newIndex >= allRows.length) return;

    // cari kolom yang sama di baris berikutnya
    const className = "." + currentInput.classList[2];
    const nextInput = allRows[newIndex].querySelector(className);

    if (nextInput) {
        nextInput.focus();
        nextInput.select?.();
    }
}

// =============== ATTACH ROW HANDLERS ==================
function attachRowHandlers(tr){
  refreshRowNumbers();
  const inpNama  = tr.querySelector('.inp-nama');
  const inpQty   = tr.querySelector('.inp-qty');
  const inpHarga = tr.querySelector('.inp-harga');
  const inpDiskon= tr.querySelector('.inp-diskon');
  const selSatuan= tr.querySelector('.inp-satuan');
  const selPajak = tr.querySelector('.inp-pajak');
  const subCell  = tr.querySelector('.subtotal-cell');
  const btnDel   = tr.querySelector('.btn-delete');
  const dd       = tr.querySelector('.dd-produk');
    intOnlyInput(inpQty);
    intOnlyInput(inpHarga);
    
    autoSelectOnFocus(inpNama);
    autoSelectOnFocus(inpQty);
    autoSelectOnFocus(inpHarga);
    autoSelectOnFocus(inpDiskon);
    formatRupiahInput(inpHarga);
    cleanDiskonInput(inpDiskon);

  // ------------------- Dropdown Navigation State -------------------
  let activeIndex = -1;
  let currentItems = [];

  function updateHighlight(){
    currentItems.forEach(el => el.classList.remove('active-highlight'));
    if(activeIndex >= 0 && currentItems[activeIndex]){
      currentItems[activeIndex].classList.add('active-highlight');
      currentItems[activeIndex].scrollIntoView({ block:"nearest" });
    }
  }

  function moveFocus(el) {
    if (!el) return;
    setTimeout(() => {
        el.focus();
        el.select && el.select();
    }, 10);
}

inpNama.addEventListener("keydown", e => {

    // ‚Üí Pindah ke kolom qty (kode lama Anda)
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(inpQty);
        return;
    }

    // ‚¨Ü Pindah ke baris atas (jika dropdown tidak terbuka)
    if (e.key === "ArrowUp" && !dd.classList.contains("show")) {
        e.preventDefault();
        moveRowFocus(inpNama, -1);
        return;
    }

    // ‚¨á Pindah ke baris bawah (jika dropdown tidak terbuka)
    if (e.key === "ArrowDown" && !dd.classList.contains("show")) {
        e.preventDefault();
        moveRowFocus(inpNama, +1);
        return;
    }
});

inpQty.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(inpNama);
    }
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(selSatuan);
    }
    if (e.key === "ArrowUp") {
        e.preventDefault();
        moveRowFocus(inpQty, -1);
        return;
    }

    if (e.key === "ArrowDown") {
        e.preventDefault();
        moveRowFocus(inpQty, +1);
        return;
    }
});

selSatuan.addEventListener("keydown", e => {

    // ‚Üê ‚Üí tetap navigasi kolom
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(inpQty);
        return;
    }
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(inpHarga);
        return;
    }

    // Alt + Arrow ‚Üí biarkan browser membuka dropdown select
    if (e.altKey) return;

    // ENTER ‚Üí pindah ke harga
    if (e.key === "Enter") {
        e.preventDefault();
        moveFocus(inpHarga);
        return;
    }

    // ArrowUp ‚Üí pindah ke baris atas
    if (e.key === "ArrowUp") {
        e.preventDefault();
        moveRowFocus(selSatuan, -1);
        return;
    }

    // ArrowDown ‚Üí pindah ke baris bawah
    if (e.key === "ArrowDown") {
        e.preventDefault();
        moveRowFocus(selSatuan, +1);
        return;
    }
});

inpHarga.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(selSatuan);
    }
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(inpDiskon);
    }
    if (e.key === "ArrowUp") {
        e.preventDefault();
        moveRowFocus(inpHarga, -1);
        return;
    }

    if (e.key === "ArrowDown") {
        e.preventDefault();
        moveRowFocus(inpHarga, +1);
        return;
    }
});
inpDiskon.addEventListener("keydown", e => {

    // ‚Üê kiri pindah ke harga
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(inpHarga);
    }

    // ‚Üí kanan pindah ke pajak
    if (e.key === "ArrowRight") {
        e.preventDefault();
        moveFocus(selPajak);
    }
    if (e.key === "ArrowUp") {
        e.preventDefault();
        moveRowFocus(inpDiskon, -1);
        return;
    }

    if (e.key === "ArrowDown") {
        e.preventDefault();
        moveRowFocus(inpDiskon, +1);
        return;
    }

    // ‚èé ENTER ‚Üí tambah baris baru
    if (e.key === "Enter") {
        e.preventDefault();

        const nama = inpNama.value.trim();
        const q = parseInt(inpQty.value) || 0;
        const h = parseInt(inpHarga.value.replace(/\./g,'')) || 0;

        if (nama && q > 0 && h > 0) {
            addRowIfNeeded();

            // Fokus ke produk di baris baru
            setTimeout(() => {
                const last = tblBody.querySelector("tr.line-row:last-child .inp-nama");
                if (last) {
                    last.focus();
                    last.select();
                }
            }, 20);
        }
    }
});

selPajak.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") {
        e.preventDefault();
        moveFocus(inpDiskon);
    }

});

function autoSelectOnFocus(el) {
    if (!el) return;
    el.addEventListener("focus", () => {
        setTimeout(() => el.select && el.select(), 10);
    });
    el.addEventListener("click", () => {
        setTimeout(() => el.select && el.select(), 10);
    });
}

autoSelectOnFocus(cari_mitra);
autoSelectOnFocus(diskon_total);
autoSelectOnFocus(biaya_lain);


  // ENTER pada kolom satuan ‚Üí fokus ke harga + select value
selSatuan.addEventListener("keydown", function(e){
    if (e.key === "Enter") {
        e.preventDefault();
        setTimeout(() => {
            inpHarga.focus();
            inpHarga.select();   // blok semua angka supaya bisa langsung ketik
        }, 10);
    }
});

  // ------------------- AUTOCOMPLETE PRODUK -------------------
  let timerP = null;

  inpNama.addEventListener('input', function(){
    clearTimeout(timerP);

    const q = this.value.trim();
    this.dataset.id = "";
    activeIndex = -1;

    if(q.length < 2){
      dd.classList.remove('show');
      dd.innerHTML = "";
      return;
    }

    timerP = setTimeout(async ()=>{
const keywords = q
  .toLowerCase()
  .split(/\s+/)
  .filter(Boolean);

let query = db
  .from("tb_produk")
  .select(`
    id_produk,
    kode_produk,
    nama_produk,
    satuan1,
    satuan2,
    satuan3,
    konversi2,
    konversi3,
    satuan_beli
  `);

// üî• SETIAP KATA HARUS MATCH (AND LOGIC)
keywords.forEach(k => {
  query = query.or(
    `nama_produk.ilike.%${k}%,kode_produk.ilike.%${k}%`
  );
});

const { data: produkList } = await query.limit(20);


      const { data: hargaList } = await db
      .from("v_harga_beli_terakhir")
      .select("id_produk, harga_beli");

    if (!produkList || !produkList.length) {
      dd.innerHTML = `<div class="dropdown-item text-muted">Tidak ada</div>`;
      dd.classList.add("show");
      return;
    }


      const hargaMap = {};
(hargaList || []).forEach(h => {
  hargaMap[h.id_produk] = h.harga_beli;
});

    dd.innerHTML = "";

produkList.forEach(p => {
  const a = document.createElement("a");
  a.className = "dropdown-item";

  a.dataset.id = p.id_produk;
  a.dataset.kode = p.kode_produk || "";
  a.dataset.nama = p.nama_produk;

  a.dataset.s1 = p.satuan1 || "";
  a.dataset.s2 = p.satuan2 || "";
  a.dataset.s3 = p.satuan3 || "";
  a.dataset.k2 = p.konversi2 || 1;
  a.dataset.k3 = p.konversi3 || 1;
  a.dataset.sb = p.satuan_beli || "";

  // üî• HARGA BELI TERAKHIR (INI INTI)
  a.dataset.harga = hargaMap[p.id_produk] || 0;

  a.textContent =
    (p.kode_produk ? p.kode_produk + " ‚Äî " : "") + p.nama_produk;

  dd.appendChild(a);
});

    dd.classList.add("show");

      currentItems = Array.from(dd.querySelectorAll('.dropdown-item'));
      activeIndex = -1;
    },150);
  });

  // ------------------- KEYBOARD NAVIGATION -------------------
  inpNama.addEventListener("keydown", function(e){
    if(!dd.classList.contains("show")) return;

    if(e.key === "ArrowDown"){
      e.preventDefault();
      if(currentItems.length === 0) return;
      activeIndex = (activeIndex + 1) % currentItems.length;
      updateHighlight();
    }

    else if(e.key === "ArrowUp"){
      e.preventDefault();
      if(currentItems.length === 0) return;
      activeIndex = (activeIndex - 1 + currentItems.length) % currentItems.length;
      updateHighlight();
    }

    else if(e.key === "Enter"){
      if(activeIndex >= 0 && currentItems[activeIndex]){
        e.preventDefault();
        currentItems[activeIndex].click();
      }
    }
  });

dd.addEventListener("click", function(e){
  const it = e.target.closest(".dropdown-item");
  if(!it) return;
  inpNama.value = it.dataset.nama;
  inpNama.dataset.id = it.dataset.id;
  const tr = inpNama.closest("tr");

  tr.dataset.s1 = it.dataset.s1;
  tr.dataset.s2 = it.dataset.s2;
  tr.dataset.s3 = it.dataset.s3;
  tr.dataset.k2 = it.dataset.k2;
  tr.dataset.k3 = it.dataset.k3;
  inpNama.title =
    (it.dataset.kode ? it.dataset.kode + " ‚Äî " : "") + it.dataset.nama;
  // auto scroll (tidak wajib sekarang karena nama lebih pendek)
  setTimeout(() => {
    inpNama.scrollLeft = inpNama.scrollWidth;
  }, 0);

  // isi satuan
  selSatuan.innerHTML = '<option value="">Pilih Satuan</option>';
  if(it.dataset.s1) selSatuan.add(new Option(it.dataset.s1, it.dataset.s1));
  if(it.dataset.s2) selSatuan.add(new Option(it.dataset.s2, it.dataset.s2));
  if(it.dataset.s3) selSatuan.add(new Option(it.dataset.s3, it.dataset.s3));

  selSatuan.value = it.dataset.sb || it.dataset.s1 || "";
  // ================= AUTO ISI HARGA BELI TERAKHIR =================
let hargaAuto = Number(it.dataset.harga || 0);
if (selSatuan.value === (it.dataset.sb || it.dataset.s1)) {
  inpHarga.value = fmt(Math.round(hargaAuto));
  inpHarga.dispatchEvent(new Event("input"));
}
  dd.classList.remove("show");
  setTimeout(()=>{
    inpQty.focus();
    inpQty.select();
  },20);
});

  // ------------------- CLICK OUTSIDE HIDE DROPDOWN -------------------
  document.addEventListener("click", (ev)=>{
    if(!tr.contains(ev.target)) dd.classList.remove("show");
  });

  // ------------------- RECALC -------------------
function recalc(){
  const q = parseInt(inpQty.value) || 0;
  // harga input mungkin berformat "100.000" -> hapus titik
  const h = parseInt((inpHarga.value||'').toString().replace(/\./g,'')) || 0;
  const base = q * h; // total sebelum diskon

  const rawDiskon = (inpDiskon.value||'').toString().trim();
  let discTotal = parseDiskon(rawDiskon, q, h);

  if(discTotal > base) discTotal = base;

  // hitung pajak berdasarkan taxable = base - discTotal
  const taxRate = TAX_RATES[selPajak.value] || 0;
  const taxable = base - discTotal;
  const taxAmount = Math.round(taxable * taxRate);

  const subtotal = taxable + taxAmount;
  subCell.innerText = fmt(subtotal);

  // jika mau tampilkan diskon per baris di kolom diskon Rp terpisah, bisa set value:
  // const perUnitDisc = Math.floor(discTotal / Math.max(1,q));
  // jika ada kolom diskon-rp, isi dengan fmt(perUnitDisc);

  refreshTotals();
}

  inpQty.addEventListener('input', recalc);
  inpHarga.addEventListener('input', recalc);
  inpDiskon.addEventListener('input', ()=> {
  // allow only digits, dot, percent and plus
  let v = (inpDiskon.value || '').toString();
  v = v.replace(/[^\d+.%]/g, '');               // hanya 0-9 + . % dan +
  v = v.replace(/\++/g, '+');                   // ganti "+++" jadi "+"
  v = v.replace(/(\.%|%\.)/g, '%');             // bersihkan kombinasi aneh
  inpDiskon.value = v;
  recalc();
});

inpDiskon.addEventListener('blur', e=>{
  let v = (e.target.value||'').toString().trim();
  if(!v) return;

  if(v.endsWith('%')){
    // biarkan "10%" atau "10%+5%"
    // kita normalisasi tiap part: if numeric <100 and no % sign, we keep as-is
    // nothing to auto-convert here
    inpDiskon.value = v;
    return;
  }

  // jika berisi '+' -> format tiap bagian nominal jika bukan persen
  if(v.includes('+')){
    const parts = v.split('+').map(p => p.trim()).map(p=>{
      if(p.endsWith('%')) return p;
      // remove existing dots then format with dots
      const n = parseInt(p.replace(/\./g,'')) || 0;
      return n === 0 ? '' : fmt(n);
    }).filter(Boolean);
    inpDiskon.value = parts.join('+');
    return;
  }

  // jika hanya angka -> anggap nominal per unit, format dengan titik (1000 -> 1.000)
  const onlyNum = v.replace(/\./g,'').replace(/,/g,'');
  if(/^\d+$/.test(onlyNum)){
    const num = parseInt(onlyNum) || 0;
    // jika kurang dari 100 mungkin pengguna maksud persen ‚Äî kalau ingin auto-convert uncomment:
    // if(num < 100){ inpDiskon.value = num + '%'; recalc(); return; }
    inpDiskon.value = num === 0 ? '' : fmt(num);
    return;
  }
});
  selPajak.addEventListener('change', recalc);

  // ------------------- ENTER ON HARGA = TAMBAH BARIS -------------------
  inpHarga.addEventListener("keydown", e=>{
    if(e.key === "Enter"){
      e.preventDefault();

      if(inpNama.value.trim() !== "" && parseInt(inpQty.value)>0 && parseInt(inpHarga.value)>0){
        addRowIfNeeded();
        setTimeout(()=>{
          const last = tblBody.querySelector('tr.line-row:last-child .inp-nama');
          if(last) last.focus();
        },20);
      }
    }
  });

  // ------------------- DELETE ROW -------------------
btnDel.addEventListener("click", ()=>{
  tr.remove();
  refreshRowNumbers();
  refreshTotals();

  if (!tblBody.querySelector("tr.line-row")) {
    tblBody.appendChild(createRow());
  }
});
}

// ===================== ADD ROW IF NEEDED =====================
function addRowIfNeeded(){
  const rows = Array.from(tblBody.querySelectorAll('tr.line-row'));
  const last = rows[rows.length-1];

  if(!last ||
     last.querySelector('.inp-nama').value.trim() !== "" ||
     parseInt(last.querySelector('.inp-harga').value) > 0){

    tblBody.appendChild(createRow());
  }
}

// ==================== ROW NUMBERING =====================
function refreshRowNumbers(){
  Array.from(tblBody.querySelectorAll('tr.line-row')).forEach((r,i)=>{
    const noCell = r.querySelector('.line-no');
    if(noCell) noCell.innerText = i+1;
  });
}

// ===================== INITIALIZE FIRST ROW =====================
if(!tblBody.querySelector('tr.line-row')){
  tblBody.appendChild(createRow());
}

// ===================== TOTALS =====================
function refreshTotals(){
  const rows = Array.from(tblBody.querySelectorAll('tr.line-row'));
  let sub = 0;

  rows.forEach(r=>{
    sub += toNum(r.querySelector('.subtotal-cell').innerText);
  });

  subTxt.innerText = fmt(sub);
  const dt = toNum(diskon_total.value);
  const bl = toNum(biaya_lain.value);
  const grand = sub - dt + bl;
  grandTxt.innerText = fmt(grand);
}

diskon_total.addEventListener('input', refreshTotals);
biaya_lain.addEventListener('input', refreshTotals);

// ===================== GATHER ITEMS =====================
function gatherItemsFromTable(){
  const items = [];

  Array.from(tblBody.querySelectorAll('.line-row')).forEach(r => {
    const nama = r.querySelector('.inp-nama').value.trim();
    if (!nama) return;

    const id_produk = r.querySelector('.inp-nama').dataset.id || null;
    const qty = parseInt(r.querySelector('.inp-qty').value) || 0;
    const satuan = r.querySelector('.inp-satuan').value || '';
    const hargaInput = toNum(r.querySelector('.inp-harga').value);
    const rawDiskon = r.querySelector('.inp-diskon').value.trim();
    const diskon_rp = parseDiskon(rawDiskon, qty, hargaInput);
    // üî• HARGA NETTO PER UNIT (SETELAH DISKON)
    const hargaNettoPerUnit =
      qty > 0
        ? (hargaInput * qty - diskon_rp) / qty
        : hargaInput;
    const pajak = r.querySelector('.inp-pajak').value || 'NO';
    const subtotal = toNum(r.querySelector('.subtotal-cell').innerText);

    // üî• HITUNG HPP SATUAN 1 (PCS)
    const hpp_satuan1 = hitungHppSatuan1({
      hargaInput: hargaNettoPerUnit,   // üî• NETTO, BUKAN HARGA ASLI
      satuanInput: satuan,
      satuan1: r.dataset.s1,
      satuan2: r.dataset.s2,
      satuan3: r.dataset.s3,
      konversi2: Number(r.dataset.k2 || 1),
      konversi3: Number(r.dataset.k3 || 1)
    });

    items.push({
      id_produk,
      nama_item: nama,
      qty,
      satuan,
      harga: hargaInput,
      hpp_satuan1,
      diskon_item: diskon_rp,
      subtotal,
      pajak,

      s1: r.dataset.s1,
      s2: r.dataset.s2,
      s3: r.dataset.s3,
      k2: Number(r.dataset.k2 || 1),
      k3: Number(r.dataset.k3 || 1),

      order_item_id: r.dataset.order_item_id || null,
      order_id: r.dataset.order_id || null, 
      qty_sisa: Number(r.dataset.qty_sisa || qty),
    });
  });
  return items;
}

async function confirmHargaNol() {
    const rows = Array.from(tblBody.querySelectorAll("tr.line-row"));
    let adaHargaNol = false;
    let pesan = "";

    rows.forEach((r, i) => {
        const nama = r.querySelector(".inp-nama").value.trim();
        const harga = parseInt((r.querySelector(".inp-harga").value || "").replace(/\./g, "")) || 0;

        if (!nama) return; // skip baris kosong

        if (harga === 0) {
            soundError();
            adaHargaNol = true;
            pesan += `- No ${i + 1} (${nama}) harganya 0\n`;
        }
    });

    if (!adaHargaNol) return true;

    // Konfirmasi
    return confirm(
        "Terdapat harga 0:\n\n" +
        pesan +
        "\nApakah Anda yakin ingin melanjutkan?"
    );

}
// ===================== ORDER STATUS =====================
async function updateOrderStatus(orderIds = []) {
  const uniqueOrders = [...new Set(orderIds)];

  for (const idOrder of uniqueOrders) {
    const { data, error } = await db
      .from("tb_order_item")
      .select("qty, qty_sisa")
      .eq("id_order", idOrder);

    if (error || !data || data.length === 0) continue;

    const total = data.length;
    const sisa = data.filter(it => {
      const v =
        it.qty_sisa != null
          ? Number(it.qty_sisa)
          : Number(it.qty);
      return v > 0;
    }).length;

    let status = "open";

    if (sisa === 0) status = "done";
    else if (sisa < total) status = "partial";

    await db
      .from("tb_order")
      .update({ status })
      .eq("id_order", idOrder);
  }
}

// ===================== SAVE =====================
btnSave.addEventListener("click", async function (e) {
    e.preventDefault();
    const lanjut = await confirmHargaNol();
    if (!lanjut) return;

    if (!AKUN_PERSEDIAAN) {
        alert("Setting akun persediaan belum siap. Coba refresh halaman.");
        return;
    }

    try {

        // === Prevent double click ===
        btnSave.disabled = true;
        btnSave.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Menyimpan...`;

        // === Gather data ===
        const items = gatherItemsFromTable();
        if (items.length === 0) throw new Error("Tambahkan minimal 1 item!");

        const kodeVal = kode.value;
        const tanggalVal = ddmmyyyyToISO(tanggal.value);
        const id_mitra = cari_mitra.dataset.id || null;
        const terminVal = termin.value;
        const tempoVal = parseInt(tempo.value) || 0;
        const ketVal = keterangan.value.trim() || null;

        const sub = items.reduce((s, it) => s + it.subtotal, 0);
        const dt = toNum(diskon_total.value);
        const bl = toNum(biaya_lain.value);
        const grand = sub - dt + bl;

        let dpVal = toNum(dp.value);

        // üîí PAKSA LOGIKA BISNIS
        if (terminVal === "cash") {
          dpVal = grand; // CASH = lunas
        }


        const t_jatuh =
          terminVal === "credit" && tempoVal > 0
            ? ddmmyyyyToISO(jatuh_tempo.value)
            : null;
        if (terminVal === "cash" && !pembayaran.value) {
          soundError();
          alert("Pilih akun pembayaran!");
          btnSave.disabled = false;
          btnSave.innerHTML = "Simpan";
          return;
        }

        // DP lebih besar dari total ‚ùå
        if (dpVal > grand) {
          soundError();
          throw new Error("DP tidak boleh lebih besar dari Grand Total");
        }
        // Peringatan saja (tidak blok)
        if (terminVal === "cash" && dpVal !== grand) {
          console.warn("CASH tapi DP tidak sama dengan Grand Total");
        }

        // CREDIT + DP wajib pilih kas/bank
        if (terminVal === "credit" && dpVal > 0 && !pembayaran.value) {
          soundError();
          throw new Error("Pilih akun pembayaran untuk DP");
        }
        if (cari_mitra.dataset.termin === "cash" && terminVal === "credit") {
          soundError();
          throw new Error("Supplier CASH tidak boleh menggunakan termin CREDIT");
        }

        // 1Ô∏è‚É£ INSERT HEADER (1x Request)
        const { data: head, error: hErr } = await db
            .from("tb_pembelian")
            .insert([
                {
                    kode_pembelian: kodeVal,
                    tanggal: tanggalVal,
                    id_mitra,
                    termin: terminVal,
                    tempo: tempoVal,
                    tanggal_jatuh_tempo: t_jatuh,
                    total_sub: sub,
                    total_diskon: dt,
                    total_biaya_lain: bl,
                    grand_total: grand,
                    dp: dpVal,    
                    keterangan: ketVal,
                },
            ])
            .select()
            .single();

        if (hErr) throw hErr;

        const idP = head.id_pembelian;

        // ============================================================
        // 2Ô∏è‚É£ INSERT DETAIL PEMBELIAN (Batch, 1x Request)
        // ============================================================
        const details = items.map(it => ({
          id_pembelian: idP,
          id_produk: it.id_produk,
          nama_item: it.nama_item,
          qty: it.qty,
          satuan: it.satuan,
          harga: it.harga,
          hpp_satuan1: it.hpp_satuan1, // üî• WAJIB
          diskon_item: it.diskon_item,
          subtotal: it.subtotal,
        }));
        const { error: dErr } = await db.from("tb_pembelian_detail").insert(details);
        if (dErr) throw dErr;
        // =====================
        // UPDATE ORDER ITEM (AKURAT)
        // =====================
        for (const it of items) {
          if (!it.order_item_id) continue;

          // üî• ambil qty_sisa TERBARU dari database
          const { data: cur, error: e1 } = await db
            .from("tb_order_item")
            .select("qty_sisa")
            .eq("id_item", it.order_item_id)
            .single();

          if (e1) throw e1;

          const qtySisaLama =
          cur.qty_sisa != null
            ? cur.qty_sisa
            : cur.qty;
          const qtySisaBaru = Math.max(0, qtySisaLama - it.qty);

          const { error: e2 } = await db
            .from("tb_order_item")
            .update({ qty_sisa: qtySisaBaru })
            .eq("id_item", it.order_item_id);

          if (e2) throw e2;
        }

        // ===================== UPDATE STATUS ORDER =====================
        const affectedOrders = items
          .map(it => it.order_id)
          .filter(Boolean);

        await updateOrderStatus(affectedOrders);
        // ============================================================
        // 3Ô∏è‚É£ INSERT MUTASI STOK (Batch, 1x Request)
        // ============================================================
        const mutasi = items
          .filter(it => it.id_produk)
          .map(it => {
            let qty_satuan1 = it.qty;

            if (it.satuan === it.s2) {
              qty_satuan1 = it.qty * it.k2;
            }
            if (it.satuan === it.s3) {
              qty_satuan1 = it.qty * it.k2 * it.k3;
            }

            return {
              id_produk: it.id_produk,
              sumber: "pembelian",
              ref_id: idP,
              tanggal: tanggalVal,
              qty: qty_satuan1,     // üî• SELALU PCS
              satuan: it.s1,        // üî• SATUAN DASAR
              keterangan: `Pembelian ${kodeVal}`,
            };
          });

        if (mutasi.length > 0) {
            const { error: mErr } = await db.from("tb_stock_mutasi").insert(mutasi);
            if (mErr) throw mErr;
        }
        // ===================== AUTO JURNAL PEMBELIAN =====================
        const namaSupplier = (cari_mitra.value || "")
          .replace(/\s+/g, " ")
          .trim();
        const totalText = fmt(grand);
        const jurnalKet = `Pembelian ${namaSupplier} : ${totalText}`;
        const { data: jurnalHead, error: jErr } = await db
          .from("tb_jurnal")
          .insert([{
            tanggal: tanggalVal,
            sumber: "pembelian",
            id_source: idP,
            keterangan: jurnalKet
          }])
          .select()
          .single();

        if (jErr) throw jErr;

        const idJurnal = jurnalHead.id_jurnal;
        let akunKredit = "";
        if (terminVal === "cash") {
            akunKredit = kasbankMap[pembayaran.value];
        } else {
            akunKredit = cari_mitra.dataset.akun_hutang;
        }

        // ===== Detail jurnal =====
        if (terminVal === "credit" && !cari_mitra.dataset.akun_hutang) {
          soundError();
          throw new Error(
            "Supplier belum memiliki akun hutang.\n" +
            "Periksa master supplier."
          );
        }

        // VALIDASI AKUN
        if (terminVal === "cash") {
          if (!pembayaran.value || !kasbankMap[pembayaran.value]) {
            soundError();
            throw new Error("Akun kas/bank belum valid");
          }
        }
        const sisaHutang = grand - dpVal;

        if (terminVal === "credit" && sisaHutang > 0) {
          if (!cari_mitra.dataset.akun_hutang) {
            soundError();
            throw new Error("Supplier belum memiliki akun hutang");
          }
        }
        
        const jurnalDetail = [
          {
            id_jurnal: idJurnal,
            kode_akun: AKUN_PERSEDIAAN,
            debit: grand,
            kredit: 0
          },

          ...(dpVal > 0 && kasbankMap[pembayaran.value] ? [{
            id_jurnal: idJurnal,
            kode_akun: kasbankMap[pembayaran.value],
            debit: 0,
            kredit: dpVal
          }] : []),

          ...(terminVal === "credit" && sisaHutang > 0 && cari_mitra.dataset.akun_hutang ? [{
            id_jurnal: idJurnal,
            kode_akun: cari_mitra.dataset.akun_hutang,
            debit: 0,
            kredit: sisaHutang
          }] : [])
        ];

        const { error: jdErr } = await db
          .from("tb_jurnal_detail")
          .insert(jurnalDetail);

        if (jdErr) throw jdErr;

        // ===================== INSERT HUTANG (JIKA CREDIT) =====================
        if (terminVal === "credit") {
          const sisa = grand - dpVal;

          const { error: htgErr } = await db
            .from("tb_hutang")
            .insert([{
              id_pembelian: idP,
              id_mitra,
              total: grand,
              sisa: sisa,
              jatuh_tempo: t_jatuh,
              status: sisa > 0 ? "open" : "paid"
            }]);

          if (htgErr) throw htgErr;
        }

        // ============================================================
        // üî• INSERT MUTASI KAS/BANK (OTOMATIS)
        // ============================================================

        // tentukan jumlah yang benar-benar keluar dari kas
        let kasKeluar = 0;

        if (terminVal === "cash") {
          // CASH = lunas
          kasKeluar = grand;
        } else if (terminVal === "credit" && dpVal > 0) {
          // CREDIT + DP
          kasKeluar = dpVal;
        }

        if (kasKeluar > 0) {
          // validasi keamanan
          if (!pembayaran.value) {
            throw new Error("Akun kas/bank belum dipilih");
          }

          // ambil KODE kasbank dari ID
          const { data: kb, error: kbErr } = await db
            .from("tb_kasbank")
            .select("kode")
            .eq("id_kasbank", pembayaran.value)
            .single();

          if (kbErr || !kb) {
            throw new Error("Data kas/bank tidak valid");
          }

          const ketKas = `Pembelian ${kodeVal}`;

          const { error: kasErr } = await db
            .from("tb_kasbank_mutasi")
            .insert([{
              tanggal: tanggalVal,
              kode_kasbank: kb.kode,
              jenis: "kredit",              // uang KELUAR
              jumlah: kasKeluar,
              keterangan: ketKas,
              ref_tabel: "tb_pembelian",
              ref_id: idP
            }]);

          if (kasErr) throw kasErr;
        }
        // ============================================================
        // 4Ô∏è‚É£ SELESAI
        // ============================================================
        alert("Pembelian berhasil disimpan: " + kodeVal);
        location.reload();
    } catch (err) {
        console.error(err);
        alert("Gagal menyimpan data:\n" + err.message);
    } finally {
        // always re-enable the button if needed
        btnSave.disabled = false;
        btnSave.innerHTML = `Simpan`;
    }
});
// ===================== ENTER NAVIGATION FORM (di luar table) =====================
document.getElementById('form').addEventListener('keydown', function(e){
  if(
    e.key === 'Enter' &&
    !e.ctrlKey &&
    !e.target.classList.contains('inp-harga') &&
    !e.target.classList.contains('inp-nama') // üî• TAMBAH INI
  ){
    e.preventDefault();

    const idx = Array.prototype.indexOf.call(this, e.target);
    if(this.elements[idx+1])
        this.elements[idx+1].focus();
  }
});

termin.addEventListener("change", () => {
  if (termin.value === "credit" && !cari_mitra.dataset.id) {
    soundError();
    alert("Pilih supplier terlebih dahulu sebelum memilih CREDIT");
    termin.value = "cash";
    tempo.value = 0;
    tempo.setAttribute("disabled","disabled");
    return;
  }

  if (termin.value === 'cash') {
    tempo.value = 0;
    tempo.setAttribute('disabled', 'disabled');
  } else {
    tempo.removeAttribute('disabled');
    tempo.value = parseInt(cari_mitra.dataset.tempo || "0") || 0;
  }
  updateTerminUI();
  updateJatuhTempo();
});
async function setDefaultSupplierCash() {
  isSettingDefaultSupplier = true;

  const CASH_ID = "011";

  const { data, error } = await db
    .from("tb_mitra")
    .select("id_mitra,nama_mitra,akun_hutang")
    .eq("kode_mitra", CASH_ID)
    .single();

  if (error || !data) {
    console.warn("Supplier CASH tidak ditemukan");
    isSettingDefaultSupplier = false;
    return;
  }

  cari_mitra.value = data.nama_mitra;
  cari_mitra.dataset.id = data.id_mitra;
  cari_mitra.dataset.termin = "cash";
  cari_mitra.dataset.tempo = "0";

  // üî• INI YANG HILANG
  cari_mitra.dataset.akun_hutang = data.akun_hutang || "";

  termin.value = "cash";
  tempo.value = 0;
  tempo.setAttribute("disabled", "disabled");
  jatuh_tempo.value = "";

  setTimeout(() => {
    isSettingDefaultSupplier = false;
  }, 50);
}

document.addEventListener("DOMContentLoaded", function () {
  const tgl = document.getElementById("tanggal");
  if (tgl) {
    setTimeout(() => {
      tgl.focus();
    }, 100);
  }
});

btnOrderan.addEventListener("click", () => {
  if (!cachedOrders.length) return;

  renderOrderPicker(cachedOrders);
  $('#modalOrderPicker').modal('show');
});

// ===================== INITIALIZE =====================
(async function initPage() {
  addRowIfNeeded();
  refreshTotals();
  await preloadSettingAkun();
  await setDefaultSupplierCash();
  updateTerminUI();
})();

let fpTanggal, fpJatuhTempo;

document.addEventListener("DOMContentLoaded", () => {

  fpTanggal = flatpickr("#tanggal", {
    dateFormat: "d/m/Y",
    locale: "id",
    allowInput: true,
    defaultDate: new Date(),
    onChange: () => updateJatuhTempo()
  });

  fpJatuhTempo = flatpickr("#jatuh_tempo", {
    dateFormat: "d/m/Y",
    locale: "id",
    allowInput: false
  });
});
</script>
</body>
</html>
